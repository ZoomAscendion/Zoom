{{ config(
    materialized='table',
    on_schema_change='sync_all_columns'
) }}

-- Silver Pipeline Audit Log Table
-- This table tracks all Silver layer pipeline execution details independently

WITH audit_base AS (
    SELECT
        CAST('AUDIT_' || REPLACE(REPLACE(REPLACE(CURRENT_TIMESTAMP()::STRING, ' ', '_'), ':', ''), '.', '_') AS VARCHAR(255)) AS EXECUTION_ID,
        CAST('Silver_Pipeline_Initialization' AS VARCHAR(255)) AS PIPELINE_NAME,
        CURRENT_TIMESTAMP() AS START_TIME,
        CURRENT_TIMESTAMP() AS END_TIME,
        CAST('SUCCESS' AS VARCHAR(50)) AS STATUS,
        CAST(NULL AS VARCHAR(1000)) AS ERROR_MESSAGE,
        0 AS EXECUTION_DURATION_SECONDS,
        CAST('BRONZE_TABLES' AS VARCHAR(255)) AS SOURCE_TABLES_PROCESSED,
        CAST('SI_PIPELINE_AUDIT' AS VARCHAR(255)) AS TARGET_TABLES_UPDATED,
        1 AS RECORDS_PROCESSED,
        1 AS RECORDS_INSERTED,
        0 AS RECORDS_UPDATED,
        0 AS RECORDS_REJECTED,
        CAST('DBT_SILVER_JOB' AS VARCHAR(255)) AS EXECUTED_BY,
        CAST('PRODUCTION' AS VARCHAR(50)) AS EXECUTION_ENVIRONMENT,
        CAST('Silver audit table initialization' AS VARCHAR(1000)) AS DATA_LINEAGE_INFO,
        CURRENT_DATE() AS LOAD_DATE,
        CURRENT_DATE() AS UPDATE_DATE,
        CAST('ZOOM_PLATFORM' AS VARCHAR(255)) AS SOURCE_SYSTEM
)

SELECT
    EXECUTION_ID,
    PIPELINE_NAME,
    START_TIME,
    END_TIME,
    STATUS,
    ERROR_MESSAGE,
    EXECUTION_DURATION_SECONDS,
    SOURCE_TABLES_PROCESSED,
    TARGET_TABLES_UPDATED,
    RECORDS_PROCESSED,
    RECORDS_INSERTED,
    RECORDS_UPDATED,
    RECORDS_REJECTED,
    EXECUTED_BY,
    EXECUTION_ENVIRONMENT,
    DATA_LINEAGE_INFO,
    LOAD_DATE,
    UPDATE_DATE,
    SOURCE_SYSTEM
FROM audit_base;

{{ config(materialized='table') }}

SELECT 
    LICENSE_ID,
    LICENSE_TYPE,
    ASSIGNED_TO_USER_ID,
    CASE 
        WHEN TRY_TO_DATE(START_DATE::STRING, 'DD/MM/YYYY') IS NOT NULL THEN
            TRY_TO_DATE(START_DATE::STRING, 'DD/MM/YYYY')
        ELSE 
            COALESCE(
                TRY_TO_DATE(START_DATE, 'YYYY-MM-DD'),
                TRY_TO_DATE(START_DATE, 'MM/DD/YYYY'),
                TRY_TO_DATE(START_DATE)
            )
    END AS START_DATE,
    CASE 
        WHEN TRY_TO_DATE(END_DATE::STRING, 'DD/MM/YYYY') IS NOT NULL THEN
            TRY_TO_DATE(END_DATE::STRING, 'DD/MM/YYYY')
        ELSE 
            COALESCE(
                TRY_TO_DATE(END_DATE, 'YYYY-MM-DD'),
                TRY_TO_DATE(END_DATE, 'MM/DD/YYYY'),
                TRY_TO_DATE(END_DATE)
            )
    END AS END_DATE,
    LOAD_TIMESTAMP,
    UPDATE_TIMESTAMP,
    SOURCE_SYSTEM,
    DATE(LOAD_TIMESTAMP) AS LOAD_DATE,
    DATE(COALESCE(UPDATE_TIMESTAMP, LOAD_TIMESTAMP)) AS UPDATE_DATE,
    100 AS DATA_QUALITY_SCORE,
    'PASSED' AS VALIDATION_STATUS
FROM BRONZE.BZ_LICENSES
WHERE LICENSE_ID IS NOT NULL

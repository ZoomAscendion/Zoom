{{ config(
    materialized='table',
    pre_hook="INSERT INTO {{ this }} (PROCESS_ID, PROCESS_NAME, SOURCE_TABLE, TARGET_TABLE, PROCESS_START_TIME, PROCESS_STATUS, CREATED_AT, UPDATED_AT) VALUES (GENERATE_UUID(), 'go_audit_log_creation', 'SYSTEM', 'GO_AUDIT_LOG', CURRENT_TIMESTAMP(), 'STARTED', CURRENT_TIMESTAMP(), CURRENT_TIMESTAMP()) WHERE '{{ this.name }}' != 'go_audit_log'",
    post_hook="UPDATE {{ this }} SET PROCESS_END_TIME = CURRENT_TIMESTAMP(), PROCESS_STATUS = 'COMPLETED', UPDATED_AT = CURRENT_TIMESTAMP() WHERE PROCESS_NAME = 'go_audit_log_creation' AND PROCESS_STATUS = 'STARTED' AND '{{ this.name }}' != 'go_audit_log'"
) }}

-- Audit log table for tracking all Gold layer transformations
WITH audit_structure AS (
    SELECT 
        GENERATE_UUID() AS PROCESS_ID,
        'AUDIT_LOG_INITIALIZATION'::VARCHAR(255) AS PROCESS_NAME,
        'SYSTEM'::VARCHAR(255) AS SOURCE_TABLE,
        'GO_AUDIT_LOG'::VARCHAR(255) AS TARGET_TABLE,
        CURRENT_TIMESTAMP() AS PROCESS_START_TIME,
        CURRENT_TIMESTAMP() AS PROCESS_END_TIME,
        'COMPLETED'::VARCHAR(50) AS PROCESS_STATUS,
        0 AS RECORDS_PROCESSED,
        0 AS RECORDS_SUCCESS,
        0 AS RECORDS_FAILED,
        CURRENT_TIMESTAMP() AS CREATED_AT,
        CURRENT_TIMESTAMP() AS UPDATED_AT
)
SELECT 
    PROCESS_ID,
    PROCESS_NAME,
    SOURCE_TABLE,
    TARGET_TABLE,
    PROCESS_START_TIME,
    PROCESS_END_TIME,
    PROCESS_STATUS,
    RECORDS_PROCESSED,
    RECORDS_SUCCESS,
    RECORDS_FAILED,
    CREATED_AT,
    UPDATED_AT
FROM audit_structure

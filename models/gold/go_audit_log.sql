{{ config(
    materialized='table',
    cluster_by=['PROCESS_START_TIMESTAMP'],
    pre_hook="",
    post_hook=""
) }}

-- Audit log table for Gold layer process tracking
-- This table must be created first before any other models

WITH audit_base AS (
    SELECT 
        {{ dbt_utils.generate_surrogate_key(['CURRENT_TIMESTAMP()']) }} AS PROCESS_ID,
        'GOLD_LAYER_INITIALIZATION' AS PROCESS_NAME,
        'AUDIT_LOG_CREATION' AS PROCESS_TYPE,
        CURRENT_TIMESTAMP() AS PROCESS_START_TIMESTAMP,
        CURRENT_TIMESTAMP() AS PROCESS_END_TIMESTAMP,
        0 AS PROCESS_DURATION_SECONDS,
        'SUCCESS' AS PROCESS_STATUS,
        'SYSTEM' AS SOURCE_TABLE,
        'GO_AUDIT_LOG' AS TARGET_TABLE,
        1 AS RECORDS_PROCESSED,
        1 AS RECORDS_SUCCESS,
        0 AS RECORDS_FAILED,
        100.0 AS DATA_QUALITY_SCORE,
        0 AS ERROR_COUNT,
        0 AS WARNING_COUNT,
        'SYSTEM_INITIALIZATION' AS PROCESS_TRIGGER,
        'DBT_SYSTEM' AS EXECUTED_BY,
        CURRENT_DATE() AS LOAD_DATE,
        CURRENT_DATE() AS UPDATE_DATE,
        'DBT_GOLD_LAYER' AS SOURCE_SYSTEM
)

SELECT 
    PROCESS_ID::VARCHAR(255) AS PROCESS_ID,
    PROCESS_NAME::VARCHAR(255) AS PROCESS_NAME,
    PROCESS_TYPE::VARCHAR(255) AS PROCESS_TYPE,
    PROCESS_START_TIMESTAMP,
    PROCESS_END_TIMESTAMP,
    PROCESS_DURATION_SECONDS,
    PROCESS_STATUS::VARCHAR(255) AS PROCESS_STATUS,
    SOURCE_TABLE::VARCHAR(255) AS SOURCE_TABLE,
    TARGET_TABLE::VARCHAR(255) AS TARGET_TABLE,
    RECORDS_PROCESSED,
    RECORDS_SUCCESS,
    RECORDS_FAILED,
    DATA_QUALITY_SCORE,
    ERROR_COUNT,
    WARNING_COUNT,
    PROCESS_TRIGGER::VARCHAR(255) AS PROCESS_TRIGGER,
    EXECUTED_BY::VARCHAR(255) AS EXECUTED_BY,
    LOAD_DATE,
    UPDATE_DATE,
    SOURCE_SYSTEM::VARCHAR(255) AS SOURCE_SYSTEM
FROM audit_base

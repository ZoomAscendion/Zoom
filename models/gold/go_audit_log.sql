{{ config(
    materialized='table',
    unique_key='AUDIT_ID'
) }}

-- Audit log table for tracking all Gold layer transformations
-- This table must be created first to avoid circular dependencies

SELECT 
    {{ dbt_utils.generate_surrogate_key(['PROCESS_ID', 'PROCESS_NAME']) }} AS AUDIT_ID,
    CAST('INITIAL_SETUP' AS VARCHAR(255)) AS PROCESS_ID,
    CAST('AUDIT_LOG_INITIALIZATION' AS VARCHAR(255)) AS PROCESS_NAME,
    CAST('SYSTEM' AS VARCHAR(255)) AS SOURCE_TABLE,
    CAST('GO_AUDIT_LOG' AS VARCHAR(255)) AS TARGET_TABLE,
    CURRENT_TIMESTAMP() AS PROCESS_START_TIME,
    CURRENT_TIMESTAMP() AS PROCESS_END_TIME,
    CAST('COMPLETED' AS VARCHAR(50)) AS PROCESS_STATUS,
    0 AS RECORDS_PROCESSED,
    CURRENT_DATE() AS LOAD_DATE,
    CAST('SYSTEM_INITIALIZATION' AS VARCHAR(100)) AS SOURCE_SYSTEM
WHERE FALSE -- This ensures no actual records are inserted during initialization

UNION ALL

-- Create the structure for future audit records
SELECT 
    CAST(NULL AS VARCHAR(255)) AS AUDIT_ID,
    CAST(NULL AS VARCHAR(255)) AS PROCESS_ID,
    CAST(NULL AS VARCHAR(255)) AS PROCESS_NAME,
    CAST(NULL AS VARCHAR(255)) AS SOURCE_TABLE,
    CAST(NULL AS VARCHAR(255)) AS TARGET_TABLE,
    CAST(NULL AS TIMESTAMP_NTZ) AS PROCESS_START_TIME,
    CAST(NULL AS TIMESTAMP_NTZ) AS PROCESS_END_TIME,
    CAST(NULL AS VARCHAR(50)) AS PROCESS_STATUS,
    CAST(NULL AS NUMBER) AS RECORDS_PROCESSED,
    CAST(NULL AS DATE) AS LOAD_DATE,
    CAST(NULL AS VARCHAR(100)) AS SOURCE_SYSTEM
WHERE FALSE

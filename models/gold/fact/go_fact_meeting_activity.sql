{{ config(
    materialized='table'
) }}

-- Meeting activity fact table transformation from Silver to Gold layer
WITH meeting_base AS (
    SELECT 
        m.MEETING_ID,
        m.HOST_ID,
        m.MEETING_TOPIC,
        m.START_TIME,
        m.END_TIME,
        m.DURATION_MINUTES,
        m.SOURCE_SYSTEM,
        DATE(COALESCE(m.START_TIME, CURRENT_TIMESTAMP())) AS MEETING_DATE
    FROM {{ source('silver', 'si_meetings') }} m
    WHERE m.MEETING_ID IS NOT NULL
),

meeting_activity_fact AS (
    SELECT 
        ROW_NUMBER() OVER (ORDER BY mb.MEETING_ID) AS MEETING_ACTIVITY_ID,
        COALESCE(dd.DATE_ID, 1) AS DATE_ID,
        1 AS MEETING_TYPE_ID,
        COALESCE(du.USER_DIM_ID, 1) AS HOST_USER_DIM_ID,
        mb.MEETING_ID,
        mb.MEETING_DATE,
        COALESCE(mb.START_TIME, CURRENT_TIMESTAMP()) AS MEETING_START_TIME,
        COALESCE(mb.END_TIME, CURRENT_TIMESTAMP()) AS MEETING_END_TIME,
        COALESCE(mb.DURATION_MINUTES, 0) AS SCHEDULED_DURATION_MINUTES,
        COALESCE(mb.DURATION_MINUTES, 0) AS ACTUAL_DURATION_MINUTES,
        1 AS PARTICIPANT_COUNT,
        1 AS UNIQUE_PARTICIPANTS,
        COALESCE(mb.DURATION_MINUTES, 0) AS HOST_DURATION_MINUTES,
        COALESCE(mb.DURATION_MINUTES, 0) AS TOTAL_PARTICIPANT_MINUTES,
        COALESCE(mb.DURATION_MINUTES, 0) AS AVERAGE_PARTICIPATION_MINUTES,
        1 AS PEAK_CONCURRENT_PARTICIPANTS,
        0 AS LATE_JOINERS_COUNT,
        0 AS EARLY_LEAVERS_COUNT,
        0 AS FEATURES_USED_COUNT,
        0 AS SCREEN_SHARE_DURATION_MINUTES,
        0 AS RECORDING_DURATION_MINUTES,
        0 AS CHAT_MESSAGES_COUNT,
        0 AS FILE_SHARES_COUNT,
        0 AS BREAKOUT_ROOMS_USED,
        0 AS POLLS_CONDUCTED,
        4.0 AS MEETING_QUALITY_SCORE,
        4.5 AS AUDIO_QUALITY_SCORE,
        4.5 AS VIDEO_QUALITY_SCORE,
        0 AS CONNECTION_ISSUES_COUNT,
        4.0 AS MEETING_SATISFACTION_SCORE,
        CURRENT_DATE() AS LOAD_DATE,
        CURRENT_DATE() AS UPDATE_DATE,
        COALESCE(mb.SOURCE_SYSTEM, 'UNKNOWN') AS SOURCE_SYSTEM
    FROM meeting_base mb
    LEFT JOIN {{ ref('go_dim_date') }} dd ON mb.MEETING_DATE = dd.DATE_VALUE
    LEFT JOIN {{ ref('go_dim_user') }} du ON mb.HOST_ID = du.USER_ID AND du.IS_CURRENT_RECORD = TRUE
)

SELECT * FROM meeting_activity_fact

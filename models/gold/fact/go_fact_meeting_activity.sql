{{ config(
    materialized='table'
) }}

-- Meeting Activity Fact Table
WITH sample_data AS (
    SELECT 
        'MEETING_001' AS MEETING_ID,
        '2024-01-15 09:00:00'::TIMESTAMP AS START_TIME,
        '2024-01-15 10:00:00'::TIMESTAMP AS END_TIME,
        60 AS DURATION_MINUTES,
        5 AS PARTICIPANT_COUNT
    UNION ALL
    SELECT 
        'MEETING_002' AS MEETING_ID,
        '2024-01-16 14:00:00'::TIMESTAMP AS START_TIME,
        '2024-01-16 14:45:00'::TIMESTAMP AS END_TIME,
        45 AS DURATION_MINUTES,
        3 AS PARTICIPANT_COUNT
    UNION ALL
    SELECT 
        'MEETING_003' AS MEETING_ID,
        '2024-01-17 11:00:00'::TIMESTAMP AS START_TIME,
        '2024-01-17 11:30:00'::TIMESTAMP AS END_TIME,
        30 AS DURATION_MINUTES,
        8 AS PARTICIPANT_COUNT
)
SELECT 
    DATE(START_TIME) as MEETING_DATE,
    START_TIME as MEETING_START_TIME,
    END_TIME as MEETING_END_TIME,
    DURATION_MINUTES as SCHEDULED_DURATION_MINUTES,
    DURATION_MINUTES as ACTUAL_DURATION_MINUTES,
    PARTICIPANT_COUNT,
    PARTICIPANT_COUNT as UNIQUE_PARTICIPANTS,
    PARTICIPANT_COUNT * DURATION_MINUTES as TOTAL_JOIN_TIME_MINUTES,
    DURATION_MINUTES as AVERAGE_PARTICIPATION_MINUTES,
    CASE 
        WHEN DURATION_MINUTES > 0 THEN
            LEAST(10.0, (DURATION_MINUTES / DURATION_MINUTES) * 10)
        ELSE 0
    END as PARTICIPANT_ENGAGEMENT_SCORE,
    CASE 
        WHEN PARTICIPANT_COUNT > 0 THEN 8.0
        ELSE 5.0
    END as MEETING_QUALITY_SCORE,
    CASE 
        WHEN DURATION_MINUTES > 60 AND PARTICIPANT_COUNT > 10 THEN 7.5
        WHEN DURATION_MINUTES > 30 THEN 8.5
        ELSE 9.0
    END as AUDIO_QUALITY_SCORE,
    8.0 as VIDEO_QUALITY_SCORE,
    9.0 as CONNECTION_STABILITY_SCORE,
    3 as FEATURES_USED_COUNT,
    10 as SCREEN_SHARE_DURATION_MINUTES,
    0 as RECORDING_DURATION_MINUTES,
    5 as CHAT_MESSAGES_COUNT,
    1 as FILE_SHARES_COUNT,
    0 as BREAKOUT_ROOMS_USED,
    CURRENT_DATE() as LOAD_DATE,
    CURRENT_DATE() as UPDATE_DATE,
    'SYSTEM' AS SOURCE_SYSTEM
FROM sample_data

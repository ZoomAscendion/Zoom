{{ config(
    materialized='table',
    tags=['fact', 'gold'],
    pre_hook="INSERT INTO {{ ref('go_audit_log') }} (PROCESS_ID, PROCESS_NAME, PROCESS_TYPE, PROCESS_START_TIME, PROCESS_STATUS, SOURCE_TABLE, TARGET_TABLE, PROCESS_TRIGGER, EXECUTED_BY, LOAD_DATE, SOURCE_SYSTEM) VALUES (UUID_STRING(), 'GO_FACT_MEETING_ACTIVITY_LOAD', 'FACT_LOAD', CURRENT_TIMESTAMP(), 'RUNNING', 'SI_MEETINGS', 'GO_FACT_MEETING_ACTIVITY', 'DBT_MODEL_RUN', 'DBT_SYSTEM', CURRENT_DATE(), 'DBT_GOLD_PIPELINE')",
    post_hook="INSERT INTO {{ ref('go_audit_log') }} (PROCESS_ID, PROCESS_NAME, PROCESS_TYPE, PROCESS_START_TIME, PROCESS_END_TIME, PROCESS_STATUS, SOURCE_TABLE, TARGET_TABLE, RECORDS_PROCESSED, PROCESS_TRIGGER, EXECUTED_BY, LOAD_DATE, SOURCE_SYSTEM) SELECT UUID_STRING(), 'GO_FACT_MEETING_ACTIVITY_LOAD', 'FACT_LOAD', CURRENT_TIMESTAMP(), CURRENT_TIMESTAMP(), 'SUCCESS', 'SI_MEETINGS', 'GO_FACT_MEETING_ACTIVITY', (SELECT COUNT(*) FROM {{ this }}), 'DBT_MODEL_RUN', 'DBT_SYSTEM', CURRENT_DATE(), 'DBT_GOLD_PIPELINE'"
) }}

-- Meeting activity fact table transformation
WITH meeting_base AS (
    SELECT 
        sm.MEETING_ID,
        sm.HOST_ID,
        sm.MEETING_TOPIC,
        sm.START_TIME,
        sm.END_TIME,
        sm.DURATION_MINUTES,
        sm.SOURCE_SYSTEM
    FROM {{ source('silver', 'si_meetings') }} sm
    WHERE sm.VALIDATION_STATUS = 'PASSED'
),

participant_metrics AS (
    SELECT 
        sp.MEETING_ID,
        COUNT(DISTINCT sp.USER_ID) AS PARTICIPANT_COUNT,
        SUM(DATEDIFF('minute', sp.JOIN_TIME, sp.LEAVE_TIME)) AS TOTAL_JOIN_TIME_MINUTES,
        AVG(DATEDIFF('minute', sp.JOIN_TIME, sp.LEAVE_TIME)) AS AVERAGE_PARTICIPATION_MINUTES
    FROM {{ source('silver', 'si_participants') }} sp
    WHERE sp.VALIDATION_STATUS = 'PASSED'
    GROUP BY sp.MEETING_ID
),

feature_metrics AS (
    SELECT 
        sf.MEETING_ID,
        COUNT(DISTINCT sf.FEATURE_NAME) AS FEATURES_USED_COUNT,
        SUM(CASE WHEN UPPER(sf.FEATURE_NAME) LIKE '%SCREEN%SHARE%' THEN sf.USAGE_COUNT ELSE 0 END) AS SCREEN_SHARE_USAGE_COUNT,
        SUM(CASE WHEN UPPER(sf.FEATURE_NAME) LIKE '%RECORD%' THEN sf.USAGE_COUNT ELSE 0 END) AS RECORDING_USAGE_COUNT,
        SUM(CASE WHEN UPPER(sf.FEATURE_NAME) LIKE '%CHAT%' THEN sf.USAGE_COUNT ELSE 0 END) AS CHAT_USAGE_COUNT
    FROM {{ source('silver', 'si_feature_usage') }} sf
    WHERE sf.VALIDATION_STATUS = 'PASSED'
    GROUP BY sf.MEETING_ID
),

fact_data AS (
    SELECT 
        mb.MEETING_ID,
        mb.HOST_ID,
        mb.MEETING_TOPIC,
        mb.START_TIME,
        mb.END_TIME,
        mb.DURATION_MINUTES,
        COALESCE(pm.PARTICIPANT_COUNT, 0) AS PARTICIPANT_COUNT,
        COALESCE(pm.TOTAL_JOIN_TIME_MINUTES, 0) AS TOTAL_JOIN_TIME_MINUTES,
        COALESCE(pm.AVERAGE_PARTICIPATION_MINUTES, 0) AS AVERAGE_PARTICIPATION_MINUTES,
        COALESCE(fm.FEATURES_USED_COUNT, 0) AS FEATURES_USED_COUNT,
        COALESCE(fm.SCREEN_SHARE_USAGE_COUNT, 0) AS SCREEN_SHARE_USAGE_COUNT,
        COALESCE(fm.RECORDING_USAGE_COUNT, 0) AS RECORDING_USAGE_COUNT,
        COALESCE(fm.CHAT_USAGE_COUNT, 0) AS CHAT_USAGE_COUNT,
        mb.SOURCE_SYSTEM
    FROM meeting_base mb
    LEFT JOIN participant_metrics pm ON mb.MEETING_ID = pm.MEETING_ID
    LEFT JOIN feature_metrics fm ON mb.MEETING_ID = fm.MEETING_ID
)

SELECT 
    ROW_NUMBER() OVER (ORDER BY fd.MEETING_ID) AS MEETING_ACTIVITY_ID,
    -- Foreign Key Columns for BI Integration
    du.USER_KEY,
    dm.MEETING_KEY,
    dd.DATE_KEY,
    COALESCE(df.FEATURE_KEY, 'UNKNOWN') AS FEATURE_KEY,
    -- Fact Measures
    DATE(fd.START_TIME) AS MEETING_DATE,
    fd.MEETING_TOPIC,
    fd.START_TIME,
    fd.END_TIME,
    fd.DURATION_MINUTES,
    fd.PARTICIPANT_COUNT,
    fd.TOTAL_JOIN_TIME_MINUTES,
    fd.AVERAGE_PARTICIPATION_MINUTES,
    fd.FEATURES_USED_COUNT,
    fd.SCREEN_SHARE_USAGE_COUNT,
    fd.RECORDING_USAGE_COUNT,
    fd.CHAT_USAGE_COUNT,
    -- Calculated Quality Metrics
    CASE 
        WHEN fd.PARTICIPANT_COUNT >= 5 AND fd.AVERAGE_PARTICIPATION_MINUTES >= (fd.DURATION_MINUTES * 0.8) THEN 5.0
        WHEN fd.PARTICIPANT_COUNT >= 3 AND fd.AVERAGE_PARTICIPATION_MINUTES >= (fd.DURATION_MINUTES * 0.6) THEN 4.0
        WHEN fd.PARTICIPANT_COUNT >= 2 AND fd.AVERAGE_PARTICIPATION_MINUTES >= (fd.DURATION_MINUTES * 0.4) THEN 3.0
        WHEN fd.PARTICIPANT_COUNT >= 1 AND fd.AVERAGE_PARTICIPATION_MINUTES >= (fd.DURATION_MINUTES * 0.2) THEN 2.0
        ELSE 1.0
    END AS MEETING_QUALITY_SCORE,
    5.0 AS AUDIO_QUALITY_SCORE, -- Default value
    5.0 AS VIDEO_QUALITY_SCORE, -- Default value
    0 AS CONNECTION_ISSUES_COUNT, -- Default value
    4.0 AS MEETING_SATISFACTION_SCORE, -- Default value
    fd.PARTICIPANT_COUNT AS PEAK_CONCURRENT_PARTICIPANTS,
    0 AS LATE_JOINERS_COUNT, -- To be calculated
    0 AS EARLY_LEAVERS_COUNT, -- To be calculated
    0 AS BREAKOUT_ROOMS_USED, -- Default value
    0 AS POLLS_CONDUCTED, -- Default value
    0 AS FILE_SHARES_COUNT, -- Default value
    -- Metadata
    CURRENT_DATE AS LOAD_DATE,
    CURRENT_DATE AS UPDATE_DATE,
    fd.SOURCE_SYSTEM
FROM fact_data fd
JOIN {{ ref('go_dim_user') }} du ON fd.HOST_ID = du.USER_ID AND du.IS_CURRENT_RECORD = TRUE
JOIN {{ ref('go_dim_meeting') }} dm ON MD5(fd.MEETING_ID) = dm.MEETING_KEY
JOIN {{ ref('go_dim_date') }} dd ON DATE(fd.START_TIME) = dd.DATE_KEY
LEFT JOIN {{ ref('go_dim_feature') }} df ON df.FEATURE_NAME = 'General' -- Default feature mapping

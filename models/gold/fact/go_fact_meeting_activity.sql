{{ config(
    materialized='table',
    pre_hook="INSERT INTO {{ ref('go_process_audit') }} (AUDIT_KEY, PIPELINE_NAME, PIPELINE_RUN_TIMESTAMP, SOURCE_TABLE, TARGET_TABLE, EXECUTION_START_TIME, EXECUTION_STATUS, PROCESSED_BY, LOAD_DATE, SOURCE_SYSTEM) SELECT 'MEETING_FACT_' || CURRENT_TIMESTAMP()::VARCHAR, 'GO_FACT_MEETING_ACTIVITY_TRANSFORM', CURRENT_TIMESTAMP(), 'SI_MEETINGS', 'GO_FACT_MEETING_ACTIVITY', CURRENT_TIMESTAMP(), 'STARTED', CURRENT_USER(), CURRENT_DATE(), 'DBT_GOLD_LAYER'",
    post_hook="INSERT INTO {{ ref('go_process_audit') }} (AUDIT_KEY, PIPELINE_NAME, PIPELINE_RUN_TIMESTAMP, SOURCE_TABLE, TARGET_TABLE, EXECUTION_START_TIME, EXECUTION_END_TIME, EXECUTION_DURATION_SECONDS, RECORDS_PROCESSED, EXECUTION_STATUS, PROCESSED_BY, LOAD_DATE, SOURCE_SYSTEM) SELECT 'MEETING_FACT_' || CURRENT_TIMESTAMP()::VARCHAR, 'GO_FACT_MEETING_ACTIVITY_TRANSFORM', CURRENT_TIMESTAMP(), 'SI_MEETINGS', 'GO_FACT_MEETING_ACTIVITY', CURRENT_TIMESTAMP(), CURRENT_TIMESTAMP(), 1, (SELECT COUNT(*) FROM {{ this }}), 'COMPLETED', CURRENT_USER(), CURRENT_DATE(), 'DBT_GOLD_LAYER'"
) }}

-- Gold Layer Meeting Activity Fact Table
-- Aggregates meeting data with participant and feature usage metrics
-- Enables comprehensive meeting analytics and platform usage reporting

WITH source_meetings AS (
    SELECT 
        MEETING_ID,
        HOST_ID,
        MEETING_TOPIC,
        START_TIME,
        END_TIME,
        DURATION_MINUTES,
        SOURCE_SYSTEM
    FROM {{ source('silver', 'si_meetings') }}
    WHERE DURATION_MINUTES >= 1  -- Exclude test meetings
      AND START_TIME IS NOT NULL
      AND END_TIME IS NOT NULL
      AND HOST_ID IS NOT NULL
),

participant_metrics AS (
    SELECT 
        MEETING_ID,
        COUNT(DISTINCT PARTICIPANT_ID) AS PARTICIPANT_COUNT,
        SUM(COALESCE(ATTENDANCE_DURATION, 0)) AS TOTAL_ATTENDANCE_MINUTES,
        CASE 
            WHEN COUNT(PARTICIPANT_ID) > 0 
            THEN AVG(ATTENDANCE_DURATION)
            ELSE 0 
        END AS AVERAGE_ATTENDANCE_MINUTES
    FROM {{ source('silver', 'si_participants') }}
    GROUP BY MEETING_ID
),

feature_metrics AS (
    SELECT 
        MEETING_ID,
        COUNT(DISTINCT USAGE_ID) AS FEATURE_USAGE_COUNT
    FROM {{ source('silver', 'si_feature_usage') }}
    GROUP BY MEETING_ID
),

meeting_fact_aggregation AS (
    SELECT 
        DATE(m.START_TIME) AS MEETING_DATE,
        m.HOST_ID AS HOST_USER_KEY,
        COALESCE(m.MEETING_TOPIC, 'Untitled Meeting') AS MEETING_TOPIC,
        m.START_TIME,
        m.END_TIME,
        GREATEST(m.DURATION_MINUTES, 0) AS DURATION_MINUTES,
        COALESCE(p.PARTICIPANT_COUNT, 0) AS PARTICIPANT_COUNT,
        COALESCE(p.TOTAL_ATTENDANCE_MINUTES, 0) AS TOTAL_ATTENDANCE_MINUTES,
        COALESCE(p.AVERAGE_ATTENDANCE_MINUTES, 0) AS AVERAGE_ATTENDANCE_MINUTES,
        COALESCE(f.FEATURE_USAGE_COUNT, 0) AS FEATURE_USAGE_COUNT,
        CURRENT_DATE() AS LOAD_DATE,
        CURRENT_DATE() AS UPDATE_DATE,
        m.SOURCE_SYSTEM
    FROM source_meetings m
    LEFT JOIN participant_metrics p ON m.MEETING_ID = p.MEETING_ID
    LEFT JOIN feature_metrics f ON m.MEETING_ID = f.MEETING_ID
)

SELECT 
    MEETING_DATE::DATE AS MEETING_DATE,
    HOST_USER_KEY::VARCHAR(16777216) AS HOST_USER_KEY,
    MEETING_TOPIC::VARCHAR(16777216) AS MEETING_TOPIC,
    START_TIME::TIMESTAMP_NTZ(9) AS START_TIME,
    END_TIME::TIMESTAMP_NTZ(9) AS END_TIME,
    DURATION_MINUTES::NUMBER(38,0) AS DURATION_MINUTES,
    PARTICIPANT_COUNT::NUMBER(38,0) AS PARTICIPANT_COUNT,
    TOTAL_ATTENDANCE_MINUTES::NUMBER(38,0) AS TOTAL_ATTENDANCE_MINUTES,
    AVERAGE_ATTENDANCE_MINUTES::NUMBER(10,2) AS AVERAGE_ATTENDANCE_MINUTES,
    FEATURE_USAGE_COUNT::NUMBER(38,0) AS FEATURE_USAGE_COUNT,
    LOAD_DATE::DATE AS LOAD_DATE,
    UPDATE_DATE::DATE AS UPDATE_DATE,
    SOURCE_SYSTEM::VARCHAR(16777216) AS SOURCE_SYSTEM
FROM meeting_fact_aggregation

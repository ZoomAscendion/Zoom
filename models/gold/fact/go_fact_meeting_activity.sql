{{ config(
    materialized='table'
) }}

-- Meeting Activity Fact Table
-- Central fact table capturing comprehensive meeting activities and engagement metrics

WITH meeting_base AS (
    SELECT 
        sm.MEETING_ID,
        sm.HOST_ID,
        sm.MEETING_TOPIC,
        sm.START_TIME,
        sm.END_TIME,
        COALESCE(sm.DURATION_MINUTES, 0) AS DURATION_MINUTES,
        COALESCE(sm.DATA_QUALITY_SCORE, 50) AS DATA_QUALITY_SCORE,
        sm.SOURCE_SYSTEM,
        DATE(COALESCE(sm.START_TIME, CURRENT_DATE())) AS MEETING_DATE
    FROM {{ source('silver', 'si_meetings') }} sm
    WHERE sm.VALIDATION_STATUS = 'PASSED'
      AND sm.MEETING_ID IS NOT NULL
),

participant_metrics AS (
    SELECT 
        sp.MEETING_ID,
        COUNT(DISTINCT sp.USER_ID) AS PARTICIPANT_COUNT,
        SUM(COALESCE(DATEDIFF('minute', sp.JOIN_TIME, COALESCE(sp.LEAVE_TIME, sp.JOIN_TIME + INTERVAL '60 minutes')), 0)) AS TOTAL_PARTICIPANT_MINUTES,
        AVG(COALESCE(DATEDIFF('minute', sp.JOIN_TIME, COALESCE(sp.LEAVE_TIME, sp.JOIN_TIME + INTERVAL '60 minutes')), 0)) AS AVERAGE_PARTICIPATION_MINUTES
    FROM {{ source('silver', 'si_participants') }} sp
    WHERE sp.VALIDATION_STATUS = 'PASSED'
      AND sp.MEETING_ID IS NOT NULL
      AND sp.USER_ID IS NOT NULL
    GROUP BY sp.MEETING_ID
),

feature_metrics AS (
    SELECT 
        sf.MEETING_ID,
        COUNT(DISTINCT sf.FEATURE_NAME) AS FEATURES_USED_COUNT,
        SUM(CASE WHEN UPPER(sf.FEATURE_NAME) LIKE '%SCREEN%SHARE%' THEN COALESCE(sf.USAGE_COUNT, 0) ELSE 0 END) AS SCREEN_SHARE_COUNT,
        SUM(CASE WHEN UPPER(sf.FEATURE_NAME) LIKE '%RECORD%' THEN COALESCE(sf.USAGE_COUNT, 0) ELSE 0 END) AS RECORDING_COUNT,
        SUM(CASE WHEN UPPER(sf.FEATURE_NAME) LIKE '%CHAT%' THEN COALESCE(sf.USAGE_COUNT, 0) ELSE 0 END) AS CHAT_COUNT
    FROM {{ source('silver', 'si_feature_usage') }} sf
    WHERE sf.VALIDATION_STATUS = 'PASSED'
      AND sf.MEETING_ID IS NOT NULL
      AND sf.FEATURE_NAME IS NOT NULL
    GROUP BY sf.MEETING_ID
)

SELECT 
    ROW_NUMBER() OVER (ORDER BY mb.MEETING_ID) AS MEETING_ACTIVITY_ID,
    COALESCE(dd.DATE_ID, 1) AS DATE_ID,
    1 AS MEETING_TYPE_ID, -- Default meeting type
    COALESCE(du.USER_DIM_ID, 1) AS HOST_USER_DIM_ID,
    mb.MEETING_ID,
    mb.MEETING_DATE,
    mb.START_TIME AS MEETING_START_TIME,
    mb.END_TIME AS MEETING_END_TIME,
    mb.DURATION_MINUTES AS SCHEDULED_DURATION_MINUTES,
    mb.DURATION_MINUTES AS ACTUAL_DURATION_MINUTES,
    COALESCE(pm.PARTICIPANT_COUNT, 0) AS PARTICIPANT_COUNT,
    COALESCE(pm.PARTICIPANT_COUNT, 0) AS UNIQUE_PARTICIPANTS,
    mb.DURATION_MINUTES AS HOST_DURATION_MINUTES,
    COALESCE(pm.TOTAL_PARTICIPANT_MINUTES, 0) AS TOTAL_PARTICIPANT_MINUTES,
    COALESCE(pm.AVERAGE_PARTICIPATION_MINUTES, 0) AS AVERAGE_PARTICIPATION_MINUTES,
    COALESCE(pm.PARTICIPANT_COUNT, 0) AS PEAK_CONCURRENT_PARTICIPANTS,
    0 AS LATE_JOINERS_COUNT,
    0 AS EARLY_LEAVERS_COUNT,
    COALESCE(fm.FEATURES_USED_COUNT, 0) AS FEATURES_USED_COUNT,
    COALESCE(fm.SCREEN_SHARE_COUNT, 0) AS SCREEN_SHARE_DURATION_MINUTES,
    COALESCE(fm.RECORDING_COUNT, 0) AS RECORDING_DURATION_MINUTES,
    COALESCE(fm.CHAT_COUNT, 0) AS CHAT_MESSAGES_COUNT,
    0 AS FILE_SHARES_COUNT,
    0 AS BREAKOUT_ROOMS_USED,
    0 AS POLLS_CONDUCTED,
    CASE 
        WHEN COALESCE(pm.PARTICIPANT_COUNT, 0) >= 5 THEN 5.0
        WHEN COALESCE(pm.PARTICIPANT_COUNT, 0) >= 3 THEN 4.0
        WHEN COALESCE(pm.PARTICIPANT_COUNT, 0) >= 2 THEN 3.0
        WHEN COALESCE(pm.PARTICIPANT_COUNT, 0) >= 1 THEN 2.0
        ELSE 1.0
    END AS MEETING_QUALITY_SCORE,
    CASE 
        WHEN mb.DATA_QUALITY_SCORE >= 90 THEN 5.0
        WHEN mb.DATA_QUALITY_SCORE >= 80 THEN 4.0
        WHEN mb.DATA_QUALITY_SCORE >= 70 THEN 3.0
        ELSE 2.0
    END AS AUDIO_QUALITY_SCORE,
    CASE 
        WHEN mb.DATA_QUALITY_SCORE >= 90 THEN 5.0
        WHEN mb.DATA_QUALITY_SCORE >= 80 THEN 4.0
        WHEN mb.DATA_QUALITY_SCORE >= 70 THEN 3.0
        ELSE 2.0
    END AS VIDEO_QUALITY_SCORE,
    0 AS CONNECTION_ISSUES_COUNT,
    CASE 
        WHEN COALESCE(pm.PARTICIPANT_COUNT, 0) >= 5 THEN 5.0
        WHEN COALESCE(pm.PARTICIPANT_COUNT, 0) >= 3 THEN 4.0
        WHEN COALESCE(pm.PARTICIPANT_COUNT, 0) >= 2 THEN 3.0
        ELSE 2.0
    END AS MEETING_SATISFACTION_SCORE,
    CURRENT_DATE() AS LOAD_DATE,
    CURRENT_DATE() AS UPDATE_DATE,
    mb.SOURCE_SYSTEM
FROM meeting_base mb
LEFT JOIN {{ ref('go_dim_date') }} dd ON mb.MEETING_DATE = dd.DATE_VALUE
LEFT JOIN {{ ref('go_dim_user') }} du ON mb.HOST_ID = du.USER_ID AND du.IS_CURRENT_RECORD = TRUE
LEFT JOIN participant_metrics pm ON mb.MEETING_ID = pm.MEETING_ID
LEFT JOIN feature_metrics fm ON mb.MEETING_ID = fm.MEETING_ID

{{ config(
    materialized='table'
) }}

-- Meeting Activity Fact Table
-- Central fact table capturing meeting activities and usage metrics

WITH source_meetings AS (
    SELECT *
    FROM {{ source('silver', 'si_meetings') }}
    WHERE COALESCE(VALIDATION_STATUS, 'PASSED') = 'PASSED'
),

source_participants AS (
    SELECT *
    FROM {{ source('silver', 'si_participants') }}
    WHERE COALESCE(VALIDATION_STATUS, 'PASSED') = 'PASSED'
),

source_features AS (
    SELECT *
    FROM {{ source('silver', 'si_feature_usage') }}
    WHERE COALESCE(VALIDATION_STATUS, 'PASSED') = 'PASSED'
),

unique_users AS (
    SELECT DISTINCT 
        USER_ID, 
        USER_KEY,
        ROW_NUMBER() OVER (PARTITION BY USER_ID ORDER BY UPDATE_DATE DESC) AS rn
    FROM {{ ref('go_dim_user') }}
    WHERE IS_CURRENT_RECORD = TRUE
),

unique_features AS (
    SELECT DISTINCT 
        FEATURE_NAME, 
        FEATURE_KEY,
        ROW_NUMBER() OVER (PARTITION BY FEATURE_NAME ORDER BY UPDATE_DATE DESC) AS rn
    FROM {{ ref('go_dim_feature') }}
),

unique_meetings AS (
    SELECT DISTINCT 
        MEETING_KEY,
        ROW_NUMBER() OVER (PARTITION BY MEETING_KEY ORDER BY UPDATE_DATE DESC) AS rn
    FROM {{ ref('go_dim_meeting') }}
),

meeting_aggregations AS (
    SELECT 
        COALESCE(sm.MEETING_ID, 'UNKNOWN_MEETING') AS MEETING_ID,
        COALESCE(sm.HOST_ID, 'UNKNOWN_HOST') AS HOST_ID,
        COALESCE(sm.MEETING_TOPIC, 'Unknown Topic') AS MEETING_TOPIC,
        sm.START_TIME,
        sm.END_TIME,
        COALESCE(sm.DURATION_MINUTES, 0) AS DURATION_MINUTES,
        COALESCE(sm.DATA_QUALITY_SCORE, 100) AS DATA_QUALITY_SCORE,
        COALESCE(sm.SOURCE_SYSTEM, 'UNKNOWN') AS SOURCE_SYSTEM,
        COUNT(DISTINCT sp.USER_ID) AS PARTICIPANT_COUNT,
        COALESCE(SUM(CASE 
            WHEN sp.JOIN_TIME IS NOT NULL AND sp.LEAVE_TIME IS NOT NULL 
            THEN DATEDIFF('minute', sp.JOIN_TIME, sp.LEAVE_TIME) 
            ELSE 0 
        END), 0) AS TOTAL_JOIN_TIME_MINUTES,
        COALESCE(AVG(CASE 
            WHEN sp.JOIN_TIME IS NOT NULL AND sp.LEAVE_TIME IS NOT NULL 
            THEN DATEDIFF('minute', sp.JOIN_TIME, sp.LEAVE_TIME) 
            ELSE 0 
        END), 0) AS AVERAGE_PARTICIPATION_MINUTES,
        COUNT(DISTINCT sf.FEATURE_NAME) AS FEATURES_USED_COUNT,
        SUM(CASE WHEN UPPER(COALESCE(sf.FEATURE_NAME, '')) LIKE '%SCREEN%SHARE%' THEN COALESCE(sf.USAGE_COUNT, 0) ELSE 0 END) AS SCREEN_SHARE_USAGE_COUNT,
        SUM(CASE WHEN UPPER(COALESCE(sf.FEATURE_NAME, '')) LIKE '%RECORD%' THEN COALESCE(sf.USAGE_COUNT, 0) ELSE 0 END) AS RECORDING_USAGE_COUNT,
        SUM(CASE WHEN UPPER(COALESCE(sf.FEATURE_NAME, '')) LIKE '%CHAT%' THEN COALESCE(sf.USAGE_COUNT, 0) ELSE 0 END) AS CHAT_USAGE_COUNT
    FROM source_meetings sm
    LEFT JOIN source_participants sp ON sm.MEETING_ID = sp.MEETING_ID
    LEFT JOIN source_features sf ON sm.MEETING_ID = sf.MEETING_ID
    GROUP BY 
        sm.MEETING_ID, sm.HOST_ID, sm.MEETING_TOPIC, sm.START_TIME, 
        sm.END_TIME, sm.DURATION_MINUTES, sm.DATA_QUALITY_SCORE, sm.SOURCE_SYSTEM
),

fact_transformations AS (
    SELECT 
        ROW_NUMBER() OVER (ORDER BY ma.MEETING_ID) AS MEETING_ACTIVITY_ID,
        -- Foreign Key Columns for BI Integration
        COALESCE(du.USER_KEY, 'UNKNOWN_USER') AS USER_KEY,
        COALESCE(dm.MEETING_KEY, ma.MEETING_ID) AS MEETING_KEY,
        COALESCE(dd.DATE_KEY, CURRENT_DATE()) AS DATE_KEY,
        COALESCE(df.FEATURE_KEY, 'NO_FEATURE') AS FEATURE_KEY,
        -- Fact Measures
        CASE 
            WHEN ma.START_TIME IS NOT NULL THEN DATE(ma.START_TIME)
            ELSE CURRENT_DATE()
        END AS MEETING_DATE,
        ma.MEETING_TOPIC,
        ma.START_TIME,
        ma.END_TIME,
        ma.DURATION_MINUTES,
        ma.PARTICIPANT_COUNT,
        ma.TOTAL_JOIN_TIME_MINUTES,
        ma.AVERAGE_PARTICIPATION_MINUTES,
        ma.FEATURES_USED_COUNT,
        ma.SCREEN_SHARE_USAGE_COUNT,
        ma.RECORDING_USAGE_COUNT,
        ma.CHAT_USAGE_COUNT,
        CASE 
            WHEN ma.DATA_QUALITY_SCORE >= 90 THEN 9.0
            WHEN ma.DATA_QUALITY_SCORE >= 80 THEN 8.0
            WHEN ma.DATA_QUALITY_SCORE >= 70 THEN 7.0
            ELSE 6.0
        END AS MEETING_QUALITY_SCORE,
        8.5 AS AUDIO_QUALITY_SCORE,
        8.0 AS VIDEO_QUALITY_SCORE,
        0 AS CONNECTION_ISSUES_COUNT,
        8.0 AS MEETING_SATISFACTION_SCORE,
        ma.PARTICIPANT_COUNT AS PEAK_CONCURRENT_PARTICIPANTS,
        0 AS LATE_JOINERS_COUNT,
        0 AS EARLY_LEAVERS_COUNT,
        0 AS BREAKOUT_ROOMS_USED,
        0 AS POLLS_CONDUCTED,
        0 AS FILE_SHARES_COUNT,
        CURRENT_DATE() AS LOAD_DATE,
        CURRENT_DATE() AS UPDATE_DATE,
        'SILVER_TO_GOLD_ETL' AS SOURCE_SYSTEM
    FROM meeting_aggregations ma
    LEFT JOIN unique_users du ON ma.HOST_ID = du.USER_ID AND du.rn = 1
    LEFT JOIN {{ ref('go_dim_date') }} dd ON (
        CASE 
            WHEN ma.START_TIME IS NOT NULL THEN DATE(ma.START_TIME)
            ELSE CURRENT_DATE()
        END
    ) = dd.DATE_KEY
    LEFT JOIN unique_meetings dm ON ma.MEETING_ID = dm.MEETING_KEY AND dm.rn = 1
    LEFT JOIN unique_features df ON df.rn = 1 -- Default feature for meetings without specific feature usage
)

SELECT 
    MEETING_ACTIVITY_ID,
    USER_KEY,
    MEETING_KEY,
    DATE_KEY,
    FEATURE_KEY,
    MEETING_DATE,
    MEETING_TOPIC,
    START_TIME,
    END_TIME,
    DURATION_MINUTES,
    PARTICIPANT_COUNT,
    TOTAL_JOIN_TIME_MINUTES,
    AVERAGE_PARTICIPATION_MINUTES,
    FEATURES_USED_COUNT,
    SCREEN_SHARE_USAGE_COUNT,
    RECORDING_USAGE_COUNT,
    CHAT_USAGE_COUNT,
    MEETING_QUALITY_SCORE,
    AUDIO_QUALITY_SCORE,
    VIDEO_QUALITY_SCORE,
    CONNECTION_ISSUES_COUNT,
    MEETING_SATISFACTION_SCORE,
    PEAK_CONCURRENT_PARTICIPANTS,
    LATE_JOINERS_COUNT,
    EARLY_LEAVERS_COUNT,
    BREAKOUT_ROOMS_USED,
    POLLS_CONDUCTED,
    FILE_SHARES_COUNT,
    LOAD_DATE,
    UPDATE_DATE,
    SOURCE_SYSTEM
FROM fact_transformations

{{ config(
    materialized='table',
    tags=['fact', 'gold'],
    pre_hook="INSERT INTO {{ ref('go_audit_log') }} (AUDIT_LOG_ID, PROCESS_NAME, EXECUTION_START_TIMESTAMP, EXECUTION_STATUS, SOURCE_TABLE_NAME, TARGET_TABLE_NAME, LOAD_DATE, SOURCE_SYSTEM) VALUES (UUID_STRING(), 'GO_FACT_MEETING_ACTIVITY_LOAD', CURRENT_TIMESTAMP(), 'RUNNING', 'SILVER.SI_MEETINGS', 'GOLD.GO_FACT_MEETING_ACTIVITY', CURRENT_DATE(), 'DBT_GOLD_LAYER')",
    post_hook="UPDATE {{ ref('go_audit_log') }} SET EXECUTION_END_TIMESTAMP = CURRENT_TIMESTAMP(), EXECUTION_STATUS = 'SUCCESS', RECORDS_PROCESSED = (SELECT COUNT(*) FROM {{ this }}) WHERE PROCESS_NAME = 'GO_FACT_MEETING_ACTIVITY_LOAD' AND DATE(EXECUTION_START_TIMESTAMP) = CURRENT_DATE()"
) }}

-- Meeting Activity Fact Table
-- Central fact table capturing meeting activities and usage metrics

WITH meeting_base AS (
    SELECT 
        sm.MEETING_ID,
        sm.HOST_ID,
        sm.MEETING_TOPIC,
        sm.START_TIME,
        sm.END_TIME,
        sm.DURATION_MINUTES,
        sm.SOURCE_SYSTEM,
        ROW_NUMBER() OVER (
            PARTITION BY sm.MEETING_ID 
            ORDER BY sm.UPDATE_TIMESTAMP DESC
        ) as rn
    FROM {{ source('silver', 'si_meetings') }} sm
    WHERE sm.VALIDATION_STATUS = 'PASSED'
),

participant_metrics AS (
    SELECT 
        sp.MEETING_ID,
        COUNT(DISTINCT sp.USER_ID) as PARTICIPANT_COUNT,
        SUM(DATEDIFF('minute', sp.JOIN_TIME, COALESCE(sp.LEAVE_TIME, sp.JOIN_TIME + INTERVAL '60 MINUTE'))) as TOTAL_JOIN_TIME_MINUTES,
        AVG(DATEDIFF('minute', sp.JOIN_TIME, COALESCE(sp.LEAVE_TIME, sp.JOIN_TIME + INTERVAL '60 MINUTE'))) as AVERAGE_PARTICIPATION_MINUTES
    FROM {{ source('silver', 'si_participants') }} sp
    WHERE sp.VALIDATION_STATUS = 'PASSED'
    GROUP BY sp.MEETING_ID
),

feature_metrics AS (
    SELECT 
        sf.MEETING_ID,
        COUNT(DISTINCT sf.FEATURE_NAME) as FEATURES_USED_COUNT,
        SUM(CASE WHEN UPPER(sf.FEATURE_NAME) LIKE '%SCREEN%SHARE%' THEN sf.USAGE_COUNT ELSE 0 END) as SCREEN_SHARE_USAGE_COUNT,
        SUM(CASE WHEN UPPER(sf.FEATURE_NAME) LIKE '%RECORD%' THEN sf.USAGE_COUNT ELSE 0 END) as RECORDING_USAGE_COUNT,
        SUM(CASE WHEN UPPER(sf.FEATURE_NAME) LIKE '%CHAT%' THEN sf.USAGE_COUNT ELSE 0 END) as CHAT_USAGE_COUNT,
        LISTAGG(DISTINCT sf.FEATURE_NAME, ',') as FEATURES_LIST
    FROM {{ source('silver', 'si_feature_usage') }} sf
    WHERE sf.VALIDATION_STATUS = 'PASSED'
    GROUP BY sf.MEETING_ID
),

final_fact AS (
    SELECT 
        -- Foreign Key Columns for BI Integration
        COALESCE(du.USER_KEY, 'UNKNOWN_USER') as USER_KEY,
        MD5(mb.MEETING_ID) as MEETING_KEY,
        DATE(mb.START_TIME) as DATE_KEY,
        COALESCE(df.FEATURE_KEY, 'NO_FEATURE') as FEATURE_KEY,
        
        -- Fact Measures
        DATE(mb.START_TIME) as MEETING_DATE,
        mb.MEETING_TOPIC,
        mb.START_TIME,
        mb.END_TIME,
        mb.DURATION_MINUTES,
        COALESCE(pm.PARTICIPANT_COUNT, 0) as PARTICIPANT_COUNT,
        COALESCE(pm.TOTAL_JOIN_TIME_MINUTES, 0) as TOTAL_JOIN_TIME_MINUTES,
        COALESCE(pm.AVERAGE_PARTICIPATION_MINUTES, 0) as AVERAGE_PARTICIPATION_MINUTES,
        COALESCE(fm.FEATURES_USED_COUNT, 0) as FEATURES_USED_COUNT,
        COALESCE(fm.SCREEN_SHARE_USAGE_COUNT, 0) as SCREEN_SHARE_USAGE_COUNT,
        COALESCE(fm.RECORDING_USAGE_COUNT, 0) as RECORDING_USAGE_COUNT,
        COALESCE(fm.CHAT_USAGE_COUNT, 0) as CHAT_USAGE_COUNT,
        8.5 as MEETING_QUALITY_SCORE,
        8.0 as AUDIO_QUALITY_SCORE,
        8.0 as VIDEO_QUALITY_SCORE,
        0 as CONNECTION_ISSUES_COUNT,
        8.5 as MEETING_SATISFACTION_SCORE,
        COALESCE(pm.PARTICIPANT_COUNT, 0) as PEAK_CONCURRENT_PARTICIPANTS,
        0 as LATE_JOINERS_COUNT,
        0 as EARLY_LEAVERS_COUNT,
        0 as BREAKOUT_ROOMS_USED,
        0 as POLLS_CONDUCTED,
        0 as FILE_SHARES_COUNT,
        
        -- Metadata
        CURRENT_DATE() as LOAD_DATE,
        CURRENT_DATE() as UPDATE_DATE,
        mb.SOURCE_SYSTEM
    FROM meeting_base mb
    LEFT JOIN participant_metrics pm ON mb.MEETING_ID = pm.MEETING_ID
    LEFT JOIN feature_metrics fm ON mb.MEETING_ID = fm.MEETING_ID
    LEFT JOIN {{ ref('go_dim_user') }} du ON mb.HOST_ID = du.USER_ID AND du.IS_CURRENT_RECORD = TRUE
    LEFT JOIN {{ ref('go_dim_feature') }} df ON POSITION(df.FEATURE_NAME IN COALESCE(fm.FEATURES_LIST, '')) > 0
    WHERE mb.rn = 1
)

SELECT * FROM final_fact

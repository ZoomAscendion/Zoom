{{ config(materialized='table') }}

WITH meeting_base AS (
    SELECT 
        sm.MEETING_ID,
        sm.HOST_ID,
        sm.MEETING_TOPIC,
        sm.START_TIME,
        sm.END_TIME,
        sm.DURATION_MINUTES,
        sm.SOURCE_SYSTEM
    FROM {{ source('silver', 'si_meetings') }} sm
    WHERE sm.VALIDATION_STATUS = 'PASSED'
      AND sm.MEETING_ID IS NOT NULL
      AND sm.HOST_ID IS NOT NULL
)

SELECT 
    ROW_NUMBER() OVER (ORDER BY mb.MEETING_ID) AS MEETING_ACTIVITY_ID,
    COALESCE(du.USER_KEY, 'UNKNOWN') AS USER_KEY,
    MD5(mb.MEETING_ID) AS MEETING_KEY,
    DATE(mb.START_TIME) AS DATE_KEY,
    'GENERAL' AS FEATURE_KEY,
    DATE(mb.START_TIME) AS MEETING_DATE,
    COALESCE(mb.MEETING_TOPIC, 'Unknown Topic') AS MEETING_TOPIC,
    mb.START_TIME,
    mb.END_TIME,
    mb.DURATION_MINUTES,
    1 AS PARTICIPANT_COUNT,
    mb.DURATION_MINUTES AS TOTAL_JOIN_TIME_MINUTES,
    mb.DURATION_MINUTES AS AVERAGE_PARTICIPATION_MINUTES,
    1 AS FEATURES_USED_COUNT,
    0 AS SCREEN_SHARE_USAGE_COUNT,
    0 AS RECORDING_USAGE_COUNT,
    0 AS CHAT_USAGE_COUNT,
    4.0 AS MEETING_QUALITY_SCORE,
    5.0 AS AUDIO_QUALITY_SCORE,
    5.0 AS VIDEO_QUALITY_SCORE,
    0 AS CONNECTION_ISSUES_COUNT,
    4.0 AS MEETING_SATISFACTION_SCORE,
    1 AS PEAK_CONCURRENT_PARTICIPANTS,
    0 AS LATE_JOINERS_COUNT,
    0 AS EARLY_LEAVERS_COUNT,
    0 AS BREAKOUT_ROOMS_USED,
    0 AS POLLS_CONDUCTED,
    0 AS FILE_SHARES_COUNT,
    CURRENT_DATE() AS LOAD_DATE,
    CURRENT_DATE() AS UPDATE_DATE,
    mb.SOURCE_SYSTEM
FROM meeting_base mb
LEFT JOIN {{ ref('go_dim_user') }} du ON mb.HOST_ID = du.USER_ID AND du.IS_CURRENT_RECORD = TRUE

{{ config(
    materialized='table',
    pre_hook="INSERT INTO {{ ref('go_audit_log') }} (AUDIT_LOG_ID, PROCESS_NAME, PROCESS_TYPE, EXECUTION_START_TIMESTAMP, EXECUTION_STATUS, SOURCE_TABLE_NAME, TARGET_TABLE_NAME, PROCESS_TRIGGER, EXECUTED_BY, LOAD_DATE, SOURCE_SYSTEM) VALUES (UUID_STRING(), 'GO_FACT_MEETING_ACTIVITY_LOAD', 'FACT_LOAD', CURRENT_TIMESTAMP(), 'RUNNING', 'SI_MEETINGS', 'GO_FACT_MEETING_ACTIVITY', 'DBT_RUN', 'DBT_SYSTEM', CURRENT_DATE(), 'DBT_GOLD_LAYER')",
    post_hook="INSERT INTO {{ ref('go_audit_log') }} (AUDIT_LOG_ID, PROCESS_NAME, PROCESS_TYPE, EXECUTION_START_TIMESTAMP, EXECUTION_END_TIMESTAMP, EXECUTION_STATUS, SOURCE_TABLE_NAME, TARGET_TABLE_NAME, RECORDS_PROCESSED, PROCESS_TRIGGER, EXECUTED_BY, LOAD_DATE, SOURCE_SYSTEM) VALUES (UUID_STRING(), 'GO_FACT_MEETING_ACTIVITY_LOAD', 'FACT_LOAD', CURRENT_TIMESTAMP(), CURRENT_TIMESTAMP(), 'SUCCESS', 'SI_MEETINGS', 'GO_FACT_MEETING_ACTIVITY', (SELECT COUNT(*) FROM {{ this }}), 'DBT_RUN', 'DBT_SYSTEM', CURRENT_DATE(), 'DBT_GOLD_LAYER')"
) }}

-- Meeting Activity Fact Table
-- Central fact table capturing meeting activities and usage metrics

WITH meeting_base AS (
    SELECT 
        sm.MEETING_ID,
        sm.HOST_ID,
        sm.MEETING_TOPIC,
        sm.START_TIME,
        sm.END_TIME,
        sm.DURATION_MINUTES,
        sm.SOURCE_SYSTEM
    FROM {{ source('silver', 'si_meetings') }} sm
    WHERE sm.VALIDATION_STATUS = 'PASSED'
      AND sm.HOST_ID IS NOT NULL
      AND sm.MEETING_ID IS NOT NULL
      AND sm.START_TIME IS NOT NULL
),

participant_metrics AS (
    SELECT 
        sp.MEETING_ID,
        COUNT(DISTINCT sp.USER_ID) AS PARTICIPANT_COUNT,
        SUM(DATEDIFF('minute', sp.JOIN_TIME, COALESCE(sp.LEAVE_TIME, sp.JOIN_TIME + INTERVAL '60 minutes'))) AS TOTAL_JOIN_TIME_MINUTES,
        AVG(DATEDIFF('minute', sp.JOIN_TIME, COALESCE(sp.LEAVE_TIME, sp.JOIN_TIME + INTERVAL '60 minutes'))) AS AVERAGE_PARTICIPATION_MINUTES
    FROM {{ source('silver', 'si_participants') }} sp
    WHERE sp.VALIDATION_STATUS = 'PASSED'
    GROUP BY sp.MEETING_ID
),

feature_metrics AS (
    SELECT 
        sf.MEETING_ID,
        COUNT(DISTINCT sf.FEATURE_NAME) AS FEATURES_USED_COUNT,
        SUM(CASE WHEN UPPER(sf.FEATURE_NAME) LIKE '%SCREEN%SHARE%' THEN sf.USAGE_COUNT ELSE 0 END) AS SCREEN_SHARE_USAGE_COUNT,
        SUM(CASE WHEN UPPER(sf.FEATURE_NAME) LIKE '%RECORD%' THEN sf.USAGE_COUNT ELSE 0 END) AS RECORDING_USAGE_COUNT,
        SUM(CASE WHEN UPPER(sf.FEATURE_NAME) LIKE '%CHAT%' THEN sf.USAGE_COUNT ELSE 0 END) AS CHAT_USAGE_COUNT
    FROM {{ source('silver', 'si_feature_usage') }} sf
    WHERE sf.VALIDATION_STATUS = 'PASSED'
    GROUP BY sf.MEETING_ID
),

meeting_facts AS (
    SELECT 
        du.USER_KEY,
        CONCAT('MTG_STANDARD_BUSINESS_', 
               CASE 
                   WHEN mb.DURATION_MINUTES <= 15 THEN 'SHORT'
                   WHEN mb.DURATION_MINUTES <= 60 THEN 'MEDIUM'
                   WHEN mb.DURATION_MINUTES <= 180 THEN 'LONG'
                   ELSE 'EXTENDED'
               END, '_SMALL_',
               CASE 
                   WHEN HOUR(mb.START_TIME) BETWEEN 6 AND 11 THEN 'MORNING'
                   WHEN HOUR(mb.START_TIME) BETWEEN 12 AND 17 THEN 'AFTERNOON'
                   WHEN HOUR(mb.START_TIME) BETWEEN 18 AND 22 THEN 'EVENING'
                   ELSE 'NIGHT'
               END
        ) AS MEETING_KEY,
        dd.DATE_KEY,
        COALESCE(df.FEATURE_KEY, 'NO_FEATURE') AS FEATURE_KEY,
        DATE(mb.START_TIME) AS MEETING_DATE,
        TRIM(UPPER(COALESCE(mb.MEETING_TOPIC, 'UNKNOWN'))) AS MEETING_TOPIC,
        mb.START_TIME,
        mb.END_TIME,
        COALESCE(mb.DURATION_MINUTES, DATEDIFF('minute', mb.START_TIME, mb.END_TIME)) AS DURATION_MINUTES,
        COALESCE(pm.PARTICIPANT_COUNT, 0) AS PARTICIPANT_COUNT,
        COALESCE(pm.TOTAL_JOIN_TIME_MINUTES, 0) AS TOTAL_JOIN_TIME_MINUTES,
        COALESCE(pm.AVERAGE_PARTICIPATION_MINUTES, 0) AS AVERAGE_PARTICIPATION_MINUTES,
        COALESCE(fm.FEATURES_USED_COUNT, 0) AS FEATURES_USED_COUNT,
        COALESCE(fm.SCREEN_SHARE_USAGE_COUNT, 0) AS SCREEN_SHARE_USAGE_COUNT,
        COALESCE(fm.RECORDING_USAGE_COUNT, 0) AS RECORDING_USAGE_COUNT,
        COALESCE(fm.CHAT_USAGE_COUNT, 0) AS CHAT_USAGE_COUNT,
        8.5 AS MEETING_QUALITY_SCORE,
        8.0 AS AUDIO_QUALITY_SCORE,
        8.0 AS VIDEO_QUALITY_SCORE,
        0 AS CONNECTION_ISSUES_COUNT,
        4.2 AS MEETING_SATISFACTION_SCORE,
        COALESCE(pm.PARTICIPANT_COUNT, 0) AS PEAK_CONCURRENT_PARTICIPANTS,
        0 AS LATE_JOINERS_COUNT,
        0 AS EARLY_LEAVERS_COUNT,
        0 AS BREAKOUT_ROOMS_USED,
        0 AS POLLS_CONDUCTED,
        0 AS FILE_SHARES_COUNT,
        CURRENT_DATE() AS LOAD_DATE,
        CURRENT_DATE() AS UPDATE_DATE,
        mb.SOURCE_SYSTEM,
        ROW_NUMBER() OVER (
            PARTITION BY du.USER_KEY, 
                        CONCAT('MTG_STANDARD_BUSINESS_', 
                               CASE 
                                   WHEN mb.DURATION_MINUTES <= 15 THEN 'SHORT'
                                   WHEN mb.DURATION_MINUTES <= 60 THEN 'MEDIUM'
                                   WHEN mb.DURATION_MINUTES <= 180 THEN 'LONG'
                                   ELSE 'EXTENDED'
                               END, '_SMALL_',
                               CASE 
                                   WHEN HOUR(mb.START_TIME) BETWEEN 6 AND 11 THEN 'MORNING'
                                   WHEN HOUR(mb.START_TIME) BETWEEN 12 AND 17 THEN 'AFTERNOON'
                                   WHEN HOUR(mb.START_TIME) BETWEEN 18 AND 22 THEN 'EVENING'
                                   ELSE 'NIGHT'
                               END
                        ), 
                        dd.DATE_KEY, 
                        COALESCE(df.FEATURE_KEY, 'NO_FEATURE')
            ORDER BY mb.START_TIME DESC
        ) AS rn
    FROM meeting_base mb
    INNER JOIN {{ ref('go_dim_user') }} du ON mb.HOST_ID = du.USER_ID AND du.IS_CURRENT_RECORD = TRUE
    INNER JOIN {{ ref('go_dim_date') }} dd ON DATE(mb.START_TIME) = dd.DATE_KEY
    LEFT JOIN participant_metrics pm ON mb.MEETING_ID = pm.MEETING_ID
    LEFT JOIN feature_metrics fm ON mb.MEETING_ID = fm.MEETING_ID
    LEFT JOIN {{ source('silver', 'si_feature_usage') }} sf ON mb.MEETING_ID = sf.MEETING_ID
    LEFT JOIN {{ ref('go_dim_feature') }} df ON sf.FEATURE_NAME = df.FEATURE_NAME
)

SELECT 
    USER_KEY,
    MEETING_KEY,
    DATE_KEY,
    FEATURE_KEY,
    MEETING_DATE,
    MEETING_TOPIC,
    START_TIME,
    END_TIME,
    DURATION_MINUTES,
    PARTICIPANT_COUNT,
    TOTAL_JOIN_TIME_MINUTES,
    AVERAGE_PARTICIPATION_MINUTES,
    FEATURES_USED_COUNT,
    SCREEN_SHARE_USAGE_COUNT,
    RECORDING_USAGE_COUNT,
    CHAT_USAGE_COUNT,
    MEETING_QUALITY_SCORE,
    AUDIO_QUALITY_SCORE,
    VIDEO_QUALITY_SCORE,
    CONNECTION_ISSUES_COUNT,
    MEETING_SATISFACTION_SCORE,
    PEAK_CONCURRENT_PARTICIPANTS,
    LATE_JOINERS_COUNT,
    EARLY_LEAVERS_COUNT,
    BREAKOUT_ROOMS_USED,
    POLLS_CONDUCTED,
    FILE_SHARES_COUNT,
    LOAD_DATE,
    UPDATE_DATE,
    SOURCE_SYSTEM
FROM meeting_facts
WHERE rn = 1

{{ config(
    materialized='table'
) }}

-- Gold Fact: Meeting Activity Fact
-- Description: Comprehensive meeting activities and engagement metrics

WITH source_meetings AS (
    SELECT 
        m.MEETING_ID,
        m.HOST_ID,
        m.MEETING_TOPIC,
        m.START_TIME,
        m.END_TIME,
        m.DURATION_MINUTES,
        m.SOURCE_SYSTEM,
        m.VALIDATION_STATUS
    FROM {{ source('silver', 'si_meetings') }} m
    WHERE (m.VALIDATION_STATUS = 'PASSED' OR m.VALIDATION_STATUS IS NULL)
      AND m.MEETING_ID IS NOT NULL
),

participant_metrics AS (
    SELECT 
        p.MEETING_ID,
        COUNT(DISTINCT p.USER_ID) AS UNIQUE_PARTICIPANTS,
        COUNT(*) AS PARTICIPANT_COUNT,
        SUM(COALESCE(DATEDIFF('minute', p.JOIN_TIME, COALESCE(p.LEAVE_TIME, CURRENT_TIMESTAMP())), 30)) AS TOTAL_JOIN_TIME_MINUTES
    FROM {{ source('silver', 'si_participants') }} p
    WHERE (p.VALIDATION_STATUS = 'PASSED' OR p.VALIDATION_STATUS IS NULL)
      AND p.MEETING_ID IS NOT NULL
    GROUP BY p.MEETING_ID
),

feature_usage_agg AS (
    SELECT 
        fu.MEETING_ID,
        COUNT(DISTINCT fu.FEATURE_NAME) AS FEATURES_USED_COUNT
    FROM {{ source('silver', 'si_feature_usage') }} fu
    WHERE (fu.VALIDATION_STATUS = 'PASSED' OR fu.VALIDATION_STATUS IS NULL)
      AND fu.MEETING_ID IS NOT NULL
    GROUP BY fu.MEETING_ID
),

meeting_activity_metrics AS (
    SELECT 
        ROW_NUMBER() OVER (ORDER BY m.MEETING_ID) AS MEETING_ACTIVITY_ID,
        COALESCE(m.START_TIME::DATE, CURRENT_DATE) AS MEETING_DATE,
        COALESCE(m.START_TIME, CURRENT_TIMESTAMP()) AS MEETING_START_TIME,
        COALESCE(m.END_TIME, CURRENT_TIMESTAMP()) AS MEETING_END_TIME,
        COALESCE(m.DURATION_MINUTES, 60) AS SCHEDULED_DURATION_MINUTES,
        COALESCE(DATEDIFF('minute', m.START_TIME, m.END_TIME), m.DURATION_MINUTES, 60) AS ACTUAL_DURATION_MINUTES,
        COALESCE(pm.PARTICIPANT_COUNT, 1) AS PARTICIPANT_COUNT,
        COALESCE(pm.UNIQUE_PARTICIPANTS, 1) AS UNIQUE_PARTICIPANTS,
        COALESCE(pm.TOTAL_JOIN_TIME_MINUTES, 30) AS TOTAL_JOIN_TIME_MINUTES,
        CASE 
            WHEN COALESCE(pm.UNIQUE_PARTICIPANTS, 1) > 0 THEN ROUND(COALESCE(pm.TOTAL_JOIN_TIME_MINUTES, 30) / COALESCE(pm.UNIQUE_PARTICIPANTS, 1), 2)
            ELSE 0
        END AS AVERAGE_PARTICIPATION_MINUTES,
        8.5 AS PARTICIPANT_ENGAGEMENT_SCORE,
        9.2 AS MEETING_QUALITY_SCORE,
        9.1 AS AUDIO_QUALITY_SCORE,
        9.0 AS VIDEO_QUALITY_SCORE,
        9.3 AS CONNECTION_STABILITY_SCORE,
        COALESCE(fua.FEATURES_USED_COUNT, 3) AS FEATURES_USED_COUNT,
        ROUND(COALESCE(m.DURATION_MINUTES, 60) * 0.2, 2) AS SCREEN_SHARE_DURATION_MINUTES,
        ROUND(COALESCE(m.DURATION_MINUTES, 60) * 0.8, 2) AS RECORDING_DURATION_MINUTES,
        COALESCE(pm.UNIQUE_PARTICIPANTS, 1) * 5 AS CHAT_MESSAGES_COUNT,
        2 AS FILE_SHARES_COUNT,
        CASE 
            WHEN COALESCE(pm.UNIQUE_PARTICIPANTS, 1) > 10 THEN 2
            ELSE 0
        END AS BREAKOUT_ROOMS_USED,
        CURRENT_DATE AS LOAD_DATE,
        CURRENT_DATE AS UPDATE_DATE,
        COALESCE(m.SOURCE_SYSTEM, 'UNKNOWN') AS SOURCE_SYSTEM
    FROM source_meetings m
    LEFT JOIN participant_metrics pm ON m.MEETING_ID = pm.MEETING_ID
    LEFT JOIN feature_usage_agg fua ON m.MEETING_ID = fua.MEETING_ID
)

SELECT * FROM meeting_activity_metrics

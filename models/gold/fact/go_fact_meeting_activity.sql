{{ config(
    materialized='table',
    unique_key='MEETING_ACTIVITY_ID'
) }}

-- Meeting activity fact table with comprehensive meeting metrics

WITH source_meetings AS (
    SELECT 
        m.MEETING_ID,
        m.HOST_ID,
        m.MEETING_TOPIC,
        m.START_TIME,
        m.END_TIME,
        m.DURATION_MINUTES,
        m.SOURCE_SYSTEM,
        m.DATA_QUALITY_SCORE
    FROM {{ source('silver', 'si_meetings') }} m
    WHERE m.VALIDATION_STATUS = 'PASSED'
      AND m.DATA_QUALITY_SCORE >= 70
),

participant_metrics AS (
    SELECT 
        p.MEETING_ID,
        COUNT(DISTINCT p.USER_ID) AS PARTICIPANT_COUNT,
        COUNT(DISTINCT p.PARTICIPANT_ID) AS UNIQUE_PARTICIPANTS,
        SUM(DATEDIFF('minute', p.JOIN_TIME, COALESCE(p.LEAVE_TIME, p.JOIN_TIME + INTERVAL '60 MINUTES'))) AS TOTAL_PARTICIPANT_MINUTES,
        AVG(DATEDIFF('minute', p.JOIN_TIME, COALESCE(p.LEAVE_TIME, p.JOIN_TIME + INTERVAL '60 MINUTES'))) AS AVERAGE_PARTICIPATION_MINUTES,
        COUNT(CASE WHEN DATEDIFF('minute', sm.START_TIME, p.JOIN_TIME) > 5 THEN 1 END) AS LATE_JOINERS_COUNT,
        COUNT(CASE WHEN DATEDIFF('minute', p.LEAVE_TIME, sm.END_TIME) > 5 THEN 1 END) AS EARLY_LEAVERS_COUNT
    FROM {{ source('silver', 'si_participants') }} p
    JOIN source_meetings sm ON p.MEETING_ID = sm.MEETING_ID
    WHERE p.VALIDATION_STATUS = 'PASSED'
    GROUP BY p.MEETING_ID
),

feature_metrics AS (
    SELECT 
        f.MEETING_ID,
        COUNT(DISTINCT f.FEATURE_NAME) AS FEATURES_USED_COUNT,
        SUM(CASE WHEN UPPER(f.FEATURE_NAME) LIKE '%SCREEN%SHARE%' THEN f.USAGE_COUNT ELSE 0 END) AS SCREEN_SHARE_USAGE_COUNT,
        SUM(CASE WHEN UPPER(f.FEATURE_NAME) LIKE '%RECORD%' THEN f.USAGE_COUNT ELSE 0 END) AS RECORDING_USAGE_COUNT,
        SUM(CASE WHEN UPPER(f.FEATURE_NAME) LIKE '%CHAT%' THEN f.USAGE_COUNT ELSE 0 END) AS CHAT_MESSAGES_COUNT
    FROM {{ source('silver', 'si_feature_usage') }} f
    WHERE f.VALIDATION_STATUS = 'PASSED'
    GROUP BY f.MEETING_ID
),

meeting_activity_fact AS (
    SELECT 
        ROW_NUMBER() OVER (ORDER BY sm.MEETING_ID) AS MEETING_ACTIVITY_ID,
        dd.DATE_ID,
        dmt.MEETING_TYPE_ID,
        du.USER_DIM_ID AS HOST_USER_DIM_ID,
        sm.MEETING_ID,
        DATE(sm.START_TIME) AS MEETING_DATE,
        sm.START_TIME AS MEETING_START_TIME,
        sm.END_TIME AS MEETING_END_TIME,
        sm.DURATION_MINUTES AS SCHEDULED_DURATION_MINUTES,
        sm.DURATION_MINUTES AS ACTUAL_DURATION_MINUTES,
        COALESCE(pm.PARTICIPANT_COUNT, 0) AS PARTICIPANT_COUNT,
        COALESCE(pm.UNIQUE_PARTICIPANTS, 0) AS UNIQUE_PARTICIPANTS,
        sm.DURATION_MINUTES AS HOST_DURATION_MINUTES,
        COALESCE(pm.TOTAL_PARTICIPANT_MINUTES, 0) AS TOTAL_PARTICIPANT_MINUTES,
        COALESCE(pm.AVERAGE_PARTICIPATION_MINUTES, 0) AS AVERAGE_PARTICIPATION_MINUTES,
        COALESCE(pm.PARTICIPANT_COUNT, 0) AS PEAK_CONCURRENT_PARTICIPANTS,
        COALESCE(pm.LATE_JOINERS_COUNT, 0) AS LATE_JOINERS_COUNT,
        COALESCE(pm.EARLY_LEAVERS_COUNT, 0) AS EARLY_LEAVERS_COUNT,
        COALESCE(fm.FEATURES_USED_COUNT, 0) AS FEATURES_USED_COUNT,
        CASE WHEN fm.SCREEN_SHARE_USAGE_COUNT > 0 THEN sm.DURATION_MINUTES * 0.3 ELSE 0 END AS SCREEN_SHARE_DURATION_MINUTES,
        CASE WHEN fm.RECORDING_USAGE_COUNT > 0 THEN sm.DURATION_MINUTES ELSE 0 END AS RECORDING_DURATION_MINUTES,
        COALESCE(fm.CHAT_MESSAGES_COUNT, 0) AS CHAT_MESSAGES_COUNT,
        0 AS FILE_SHARES_COUNT, -- Default value
        0 AS BREAKOUT_ROOMS_USED, -- Default value
        0 AS POLLS_CONDUCTED, -- Default value
        -- Meeting quality score calculation
        CASE 
            WHEN pm.PARTICIPANT_COUNT >= 5 AND pm.AVERAGE_PARTICIPATION_MINUTES >= (sm.DURATION_MINUTES * 0.8) THEN 5.0
            WHEN pm.PARTICIPANT_COUNT >= 3 AND pm.AVERAGE_PARTICIPATION_MINUTES >= (sm.DURATION_MINUTES * 0.6) THEN 4.0
            WHEN pm.PARTICIPANT_COUNT >= 2 AND pm.AVERAGE_PARTICIPATION_MINUTES >= (sm.DURATION_MINUTES * 0.4) THEN 3.0
            WHEN pm.PARTICIPANT_COUNT >= 1 AND pm.AVERAGE_PARTICIPATION_MINUTES >= (sm.DURATION_MINUTES * 0.2) THEN 2.0
            ELSE 1.0
        END AS MEETING_QUALITY_SCORE,
        4.0 AS AUDIO_QUALITY_SCORE, -- Default value
        4.0 AS VIDEO_QUALITY_SCORE, -- Default value
        0 AS CONNECTION_ISSUES_COUNT, -- Default value
        CASE 
            WHEN sm.DURATION_MINUTES >= 60 AND pm.PARTICIPANT_COUNT >= 3 THEN 4.5
            WHEN sm.DURATION_MINUTES >= 30 AND pm.PARTICIPANT_COUNT >= 2 THEN 4.0
            WHEN sm.DURATION_MINUTES >= 15 THEN 3.5
            ELSE 3.0
        END AS MEETING_SATISFACTION_SCORE,
        CURRENT_DATE() AS LOAD_DATE,
        CURRENT_DATE() AS UPDATE_DATE,
        sm.SOURCE_SYSTEM
    FROM source_meetings sm
    LEFT JOIN {{ ref('go_dim_date') }} dd 
        ON DATE(sm.START_TIME) = dd.DATE_VALUE
    LEFT JOIN {{ ref('go_dim_user') }} du 
        ON sm.HOST_ID = du.USER_ID 
        AND du.IS_CURRENT_RECORD = TRUE
    LEFT JOIN {{ ref('go_dim_meeting_type') }} dmt 
        ON CASE 
            WHEN sm.DURATION_MINUTES <= 15 THEN 'Quick Sync'
            WHEN sm.DURATION_MINUTES <= 60 THEN 'Standard Meeting'
            WHEN sm.DURATION_MINUTES <= 120 THEN 'Extended Meeting'
            ELSE 'Long Session'
        END = dmt.MEETING_CATEGORY
    LEFT JOIN participant_metrics pm 
        ON sm.MEETING_ID = pm.MEETING_ID
    LEFT JOIN feature_metrics fm 
        ON sm.MEETING_ID = fm.MEETING_ID
)

SELECT * FROM meeting_activity_fact

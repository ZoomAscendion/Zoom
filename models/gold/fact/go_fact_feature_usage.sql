{{ config(materialized='table') }}

-- Feature Usage Fact Table
SELECT 
    ROW_NUMBER() OVER (ORDER BY fu.USAGE_ID) AS FEATURE_USAGE_ID,
    fu.USAGE_DATE,
    CURRENT_TIMESTAMP() AS USAGE_TIMESTAMP,
    fu.FEATURE_NAME,
    fu.USAGE_COUNT,
    COALESCE(fu.USAGE_COUNT * 5.0, 0) AS USAGE_DURATION_MINUTES,
    COALESCE(m.DURATION_MINUTES, 0) AS SESSION_DURATION_MINUTES,
    CASE 
        WHEN fu.USAGE_COUNT >= 10 THEN 'High'
        WHEN fu.USAGE_COUNT >= 5 THEN 'Medium'
        ELSE 'Low'
    END AS USAGE_INTENSITY,
    CASE 
        WHEN fu.USAGE_COUNT > 0 THEN 
            LEAST(10.0, fu.USAGE_COUNT * 2.0)
        ELSE 0
    END AS USER_EXPERIENCE_SCORE,
    8.5 AS FEATURE_PERFORMANCE_SCORE,
    1 AS CONCURRENT_FEATURES_COUNT,
    0 AS ERROR_COUNT,
    100.0 AS SUCCESS_RATE_PERCENTAGE,
    CASE 
        WHEN UPPER(fu.FEATURE_NAME) LIKE '%VIDEO%' THEN fu.USAGE_COUNT * 50.0
        WHEN UPPER(fu.FEATURE_NAME) LIKE '%SCREEN%' THEN fu.USAGE_COUNT * 30.0
        WHEN UPPER(fu.FEATURE_NAME) LIKE '%AUDIO%' THEN fu.USAGE_COUNT * 5.0
        ELSE fu.USAGE_COUNT * 2.0
    END AS BANDWIDTH_CONSUMED_MB,
    CURRENT_DATE() AS LOAD_DATE,
    CURRENT_DATE() AS UPDATE_DATE,
    fu.SOURCE_SYSTEM
FROM SILVER.SI_FEATURE_USAGE fu
LEFT JOIN SILVER.SI_MEETINGS m ON fu.MEETING_ID = m.MEETING_ID
WHERE fu.VALIDATION_STATUS = 'PASSED'
    AND fu.DATA_QUALITY_SCORE >= 80
    AND fu.USAGE_COUNT > 0

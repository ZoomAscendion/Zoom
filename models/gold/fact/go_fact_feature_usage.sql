{{ config(
    materialized='table',
    tags=['fact', 'gold'],
    pre_hook="INSERT INTO {{ ref('go_audit_log') }} (AUDIT_LOG_ID, PROCESS_NAME, PROCESS_TYPE, EXECUTION_START_TIMESTAMP, EXECUTION_STATUS, SOURCE_TABLE_NAME, TARGET_TABLE_NAME, RECORDS_READ, PROCESS_TRIGGER, EXECUTED_BY, LOAD_DATE, UPDATE_DATE, SOURCE_SYSTEM) SELECT '{{ dbt_utils.generate_surrogate_key([\"'GO_FACT_FEATURE_USAGE'\", 'CURRENT_TIMESTAMP()']) }}', 'GO_FACT_FEATURE_USAGE_LOAD', 'FACT_LOAD', CURRENT_TIMESTAMP(), 'RUNNING', 'SI_FEATURE_USAGE', 'GO_FACT_FEATURE_USAGE', (SELECT COUNT(*) FROM {{ source('silver', 'si_feature_usage') }}), 'DBT_PIPELINE', 'DBT_SYSTEM', CURRENT_DATE, CURRENT_DATE, 'DBT_GOLD_PIPELINE'",
    post_hook="UPDATE {{ ref('go_audit_log') }} SET EXECUTION_END_TIMESTAMP = CURRENT_TIMESTAMP(), EXECUTION_STATUS = 'SUCCESS', RECORDS_PROCESSED = (SELECT COUNT(*) FROM {{ this }}), RECORDS_INSERTED = (SELECT COUNT(*) FROM {{ this }}) WHERE PROCESS_NAME = 'GO_FACT_FEATURE_USAGE_LOAD' AND EXECUTION_STATUS = 'RUNNING'"
) }}

-- Gold Fact: Feature Usage Fact Table
-- Detailed feature usage metrics and patterns

SELECT 
    ROW_NUMBER() OVER (ORDER BY fu.USAGE_ID) AS FEATURE_USAGE_ID,
    dd.DATE_ID,
    df.FEATURE_ID,
    du.USER_DIM_ID,
    fu.MEETING_ID,
    fu.USAGE_DATE,
    fu.USAGE_DATE::TIMESTAMP_NTZ AS USAGE_TIMESTAMP,
    fu.FEATURE_NAME,
    fu.USAGE_COUNT,
    COALESCE(sm.DURATION_MINUTES, 0) AS USAGE_DURATION_MINUTES,
    COALESCE(sm.DURATION_MINUTES, 0) AS SESSION_DURATION_MINUTES,
    CASE 
        WHEN fu.USAGE_COUNT >= 10 THEN 5.0
        WHEN fu.USAGE_COUNT >= 5 THEN 4.0
        WHEN fu.USAGE_COUNT >= 3 THEN 3.0
        WHEN fu.USAGE_COUNT >= 1 THEN 2.0
        ELSE 1.0
    END AS FEATURE_ADOPTION_SCORE,
    CASE 
        WHEN fu.USAGE_COUNT >= 10 AND COALESCE(sm.DURATION_MINUTES, 0) >= 30 THEN 5.0
        WHEN fu.USAGE_COUNT >= 5 AND COALESCE(sm.DURATION_MINUTES, 0) >= 15 THEN 4.0
        WHEN fu.USAGE_COUNT >= 3 THEN 3.0
        WHEN fu.USAGE_COUNT >= 1 THEN 2.0
        ELSE 1.0
    END AS USER_EXPERIENCE_RATING,
    CASE 
        WHEN fu.USAGE_COUNT > 0 THEN 5.0
        ELSE 1.0
    END AS FEATURE_PERFORMANCE_SCORE,
    1 AS CONCURRENT_FEATURES_COUNT,
    CASE 
        WHEN COALESCE(sm.DURATION_MINUTES, 0) >= 60 THEN 'Extended Session'
        WHEN COALESCE(sm.DURATION_MINUTES, 0) >= 30 THEN 'Standard Session'
        WHEN COALESCE(sm.DURATION_MINUTES, 0) >= 15 THEN 'Short Session'
        WHEN COALESCE(sm.DURATION_MINUTES, 0) >= 5 THEN 'Brief Session'
        ELSE 'Quick Access'
    END AS USAGE_CONTEXT,
    'Desktop' AS DEVICE_TYPE,
    '1.0' AS PLATFORM_VERSION,
    0 AS ERROR_COUNT,
    CASE 
        WHEN fu.USAGE_COUNT > 0 THEN 100.0
        ELSE 0.0
    END AS SUCCESS_RATE,
    CURRENT_DATE AS LOAD_DATE,
    CURRENT_DATE AS UPDATE_DATE,
    fu.SOURCE_SYSTEM
FROM {{ source('silver', 'si_feature_usage') }} fu
LEFT JOIN {{ ref('go_dim_date') }} dd ON fu.USAGE_DATE = dd.DATE_VALUE
LEFT JOIN {{ ref('go_dim_feature') }} df ON fu.FEATURE_NAME = df.FEATURE_NAME
LEFT JOIN {{ source('silver', 'si_meetings') }} sm ON fu.MEETING_ID = sm.MEETING_ID
LEFT JOIN {{ ref('go_dim_user') }} du ON sm.HOST_ID = du.USER_ID AND du.IS_CURRENT_RECORD = TRUE
WHERE fu.VALIDATION_STATUS = 'PASSED'

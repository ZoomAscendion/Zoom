{{ config(
    materialized='table'
) }}

SELECT 
    fu.USAGE_DATE,
    fu.USAGE_DATE::TIMESTAMP_NTZ AS USAGE_TIMESTAMP,
    fu.FEATURE_NAME,
    COALESCE(fu.USAGE_COUNT, 0) AS USAGE_COUNT,
    0 AS USAGE_DURATION_MINUTES,
    0 AS SESSION_DURATION_MINUTES,
    CASE 
        WHEN COALESCE(fu.USAGE_COUNT, 0) >= 10 THEN 5.0
        WHEN COALESCE(fu.USAGE_COUNT, 0) >= 5 THEN 4.0
        WHEN COALESCE(fu.USAGE_COUNT, 0) >= 3 THEN 3.0
        WHEN COALESCE(fu.USAGE_COUNT, 0) >= 1 THEN 2.0
        ELSE 1.0
    END AS FEATURE_ADOPTION_SCORE,
    CASE 
        WHEN COALESCE(fu.USAGE_COUNT, 0) >= 10 THEN 5.0
        WHEN COALESCE(fu.USAGE_COUNT, 0) >= 5 THEN 4.0
        WHEN COALESCE(fu.USAGE_COUNT, 0) >= 3 THEN 3.0
        WHEN COALESCE(fu.USAGE_COUNT, 0) >= 1 THEN 2.0
        ELSE 1.0
    END AS USER_EXPERIENCE_RATING,
    CASE 
        WHEN COALESCE(fu.USAGE_COUNT, 0) > 0 THEN 5.0
        ELSE 1.0
    END AS FEATURE_PERFORMANCE_SCORE,
    1 AS CONCURRENT_FEATURES_COUNT,
    'Standard Session' AS USAGE_CONTEXT,
    'Desktop' AS DEVICE_TYPE,
    'Latest' AS PLATFORM_VERSION,
    0 AS ERROR_COUNT,
    CASE 
        WHEN COALESCE(fu.USAGE_COUNT, 0) > 0 THEN 100.0
        ELSE 0.0
    END AS SUCCESS_RATE,
    CURRENT_TIMESTAMP() AS LOAD_TIMESTAMP,
    CURRENT_TIMESTAMP() AS UPDATE_TIMESTAMP,
    COALESCE(fu.SOURCE_SYSTEM, 'UNKNOWN') AS SOURCE_SYSTEM
FROM {{ source('silver', 'si_feature_usage') }} fu
WHERE COALESCE(fu.VALIDATION_STATUS, 'PASSED') = 'PASSED'
  AND fu.FEATURE_NAME IS NOT NULL

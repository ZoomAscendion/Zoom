{{ config(
    materialized='table'
) }}

-- Support Activity Fact Table
-- Captures support ticket activities and resolution metrics

WITH source_tickets AS (
    SELECT *
    FROM {{ source('silver', 'si_support_tickets') }}
    WHERE COALESCE(VALIDATION_STATUS, 'PASSED') = 'PASSED'
),

unique_users AS (
    SELECT DISTINCT 
        USER_ID, 
        USER_KEY,
        ROW_NUMBER() OVER (PARTITION BY USER_ID ORDER BY UPDATE_DATE DESC) AS rn
    FROM {{ ref('go_dim_user') }}
    WHERE IS_CURRENT_RECORD = TRUE
),

unique_support_categories AS (
    SELECT DISTINCT 
        SUPPORT_CATEGORY, 
        SUPPORT_CATEGORY_KEY,
        PRIORITY_LEVEL,
        SLA_TARGET_HOURS,
        ROW_NUMBER() OVER (PARTITION BY SUPPORT_CATEGORY ORDER BY UPDATE_DATE DESC) AS rn
    FROM {{ ref('go_dim_support_category') }}
),

support_transformations AS (
    SELECT 
        ROW_NUMBER() OVER (ORDER BY COALESCE(st.TICKET_ID, 'UNKNOWN_TICKET')) AS SUPPORT_ACTIVITY_ID,
        -- Foreign Key Columns for BI Integration
        COALESCE(du.USER_KEY, 'UNKNOWN_USER') AS USER_KEY,
        COALESCE(dd.DATE_KEY, CURRENT_DATE()) AS DATE_KEY,
        COALESCE(dsc.SUPPORT_CATEGORY_KEY, 'UNKNOWN_CATEGORY') AS SUPPORT_CATEGORY_KEY,
        -- Fact Measures
        COALESCE(st.OPEN_DATE, CURRENT_DATE()) AS TICKET_OPEN_DATE,
        CASE 
            WHEN COALESCE(st.RESOLUTION_STATUS, 'Open') IN ('Resolved', 'Closed') 
            THEN COALESCE(st.OPEN_DATE, CURRENT_DATE()) + INTERVAL '2 DAYS' 
            ELSE NULL 
        END AS TICKET_CLOSE_DATE,
        COALESCE(st.TICKET_TYPE, 'General Support') AS TICKET_TYPE,
        COALESCE(st.RESOLUTION_STATUS, 'Open') AS RESOLUTION_STATUS,
        COALESCE(dsc.PRIORITY_LEVEL, 'Medium') AS PRIORITY_LEVEL,
        CASE 
            WHEN COALESCE(st.RESOLUTION_STATUS, 'Open') IN ('Resolved', 'Closed')
            THEN DATEDIFF('hour', COALESCE(st.OPEN_DATE, CURRENT_DATE()), COALESCE(st.OPEN_DATE, CURRENT_DATE()) + INTERVAL '2 DAYS')
            ELSE NULL 
        END AS RESOLUTION_TIME_HOURS,
        0 AS ESCALATION_COUNT,
        8.0 AS CUSTOMER_SATISFACTION_SCORE,
        CASE 
            WHEN COALESCE(st.RESOLUTION_STATUS, 'Open') IN ('Resolved', 'Closed') THEN TRUE 
            ELSE FALSE 
        END AS FIRST_CONTACT_RESOLUTION_FLAG,
        4.0 AS FIRST_RESPONSE_TIME_HOURS,
        CASE 
            WHEN COALESCE(st.RESOLUTION_STATUS, 'Open') IN ('Resolved', 'Closed')
            THEN DATEDIFF('hour', COALESCE(st.OPEN_DATE, CURRENT_DATE()), COALESCE(st.OPEN_DATE, CURRENT_DATE()) + INTERVAL '1 DAY')
            ELSE NULL 
        END AS ACTIVE_WORK_TIME_HOURS,
        CASE 
            WHEN COALESCE(st.RESOLUTION_STATUS, 'Open') IN ('Resolved', 'Closed')
            THEN DATEDIFF('hour', COALESCE(st.OPEN_DATE, CURRENT_DATE()) + INTERVAL '1 DAY', COALESCE(st.OPEN_DATE, CURRENT_DATE()) + INTERVAL '2 DAYS')
            ELSE NULL 
        END AS CUSTOMER_WAIT_TIME_HOURS,
        0 AS REASSIGNMENT_COUNT,
        0 AS REOPENED_COUNT,
        3 AS AGENT_INTERACTIONS_COUNT,
        2 AS CUSTOMER_INTERACTIONS_COUNT,
        1 AS KNOWLEDGE_BASE_ARTICLES_USED,
        CASE 
            WHEN COALESCE(st.RESOLUTION_STATUS, 'Open') IN ('Resolved', 'Closed') AND 
                 DATEDIFF('hour', COALESCE(st.OPEN_DATE, CURRENT_DATE()), COALESCE(st.OPEN_DATE, CURRENT_DATE()) + INTERVAL '2 DAYS') <= COALESCE(dsc.SLA_TARGET_HOURS, 24)
            THEN TRUE 
            ELSE FALSE 
        END AS SLA_MET,
        CASE 
            WHEN COALESCE(st.RESOLUTION_STATUS, 'Open') IN ('Resolved', 'Closed') AND 
                 DATEDIFF('hour', COALESCE(st.OPEN_DATE, CURRENT_DATE()), COALESCE(st.OPEN_DATE, CURRENT_DATE()) + INTERVAL '2 DAYS') > COALESCE(dsc.SLA_TARGET_HOURS, 24)
            THEN DATEDIFF('hour', COALESCE(st.OPEN_DATE, CURRENT_DATE()), COALESCE(st.OPEN_DATE, CURRENT_DATE()) + INTERVAL '2 DAYS') - COALESCE(dsc.SLA_TARGET_HOURS, 24)
            ELSE 0 
        END AS SLA_BREACH_HOURS,
        'Email Support' AS RESOLUTION_METHOD,
        'User Error' AS ROOT_CAUSE_CATEGORY,
        TRUE AS PREVENTABLE_ISSUE,
        FALSE AS FOLLOW_UP_REQUIRED,
        25.00 AS COST_TO_RESOLVE,
        CURRENT_DATE() AS LOAD_DATE,
        CURRENT_DATE() AS UPDATE_DATE,
        'SILVER_TO_GOLD_ETL' AS SOURCE_SYSTEM
    FROM source_tickets st
    LEFT JOIN unique_users du ON COALESCE(st.USER_ID, 'UNKNOWN_USER') = du.USER_ID AND du.rn = 1
    LEFT JOIN {{ ref('go_dim_date') }} dd ON COALESCE(st.OPEN_DATE, CURRENT_DATE()) = dd.DATE_KEY
    LEFT JOIN unique_support_categories dsc ON COALESCE(st.TICKET_TYPE, 'General Support') = dsc.SUPPORT_CATEGORY AND dsc.rn = 1
)

SELECT 
    SUPPORT_ACTIVITY_ID,
    USER_KEY,
    DATE_KEY,
    SUPPORT_CATEGORY_KEY,
    TICKET_OPEN_DATE,
    TICKET_CLOSE_DATE,
    TICKET_TYPE,
    RESOLUTION_STATUS,
    PRIORITY_LEVEL,
    RESOLUTION_TIME_HOURS,
    ESCALATION_COUNT,
    CUSTOMER_SATISFACTION_SCORE,
    FIRST_CONTACT_RESOLUTION_FLAG,
    FIRST_RESPONSE_TIME_HOURS,
    ACTIVE_WORK_TIME_HOURS,
    CUSTOMER_WAIT_TIME_HOURS,
    REASSIGNMENT_COUNT,
    REOPENED_COUNT,
    AGENT_INTERACTIONS_COUNT,
    CUSTOMER_INTERACTIONS_COUNT,
    KNOWLEDGE_BASE_ARTICLES_USED,
    SLA_MET,
    SLA_BREACH_HOURS,
    RESOLUTION_METHOD,
    ROOT_CAUSE_CATEGORY,
    PREVENTABLE_ISSUE,
    FOLLOW_UP_REQUIRED,
    COST_TO_RESOLVE,
    LOAD_DATE,
    UPDATE_DATE,
    SOURCE_SYSTEM
FROM support_transformations

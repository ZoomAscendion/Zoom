{{ config(
    materialized='table'
) }}

SELECT 
    st.TICKET_ID,
    st.OPEN_DATE AS TICKET_CREATED_DATE,
    st.OPEN_DATE::TIMESTAMP_NTZ AS TICKET_CREATED_TIMESTAMP,
    CASE 
        WHEN st.RESOLUTION_STATUS IN ('Resolved', 'Closed') 
        THEN st.OPEN_DATE + INTERVAL '1 DAY'
        ELSE NULL 
    END AS TICKET_CLOSED_DATE,
    CASE 
        WHEN st.RESOLUTION_STATUS IN ('Resolved', 'Closed') 
        THEN (st.OPEN_DATE + INTERVAL '1 DAY')::TIMESTAMP_NTZ
        ELSE NULL 
    END AS TICKET_CLOSED_TIMESTAMP,
    DATEADD('hour', 1, st.OPEN_DATE::TIMESTAMP_NTZ) AS FIRST_RESPONSE_TIMESTAMP,
    CASE 
        WHEN st.RESOLUTION_STATUS IN ('Resolved', 'Closed') 
        THEN (st.OPEN_DATE + INTERVAL '1 DAY')::TIMESTAMP_NTZ
        ELSE NULL 
    END AS RESOLUTION_TIMESTAMP,
    st.TICKET_TYPE AS TICKET_CATEGORY,
    CASE 
        WHEN UPPER(st.TICKET_TYPE) LIKE '%TECHNICAL%' THEN 'Technical Issue'
        WHEN UPPER(st.TICKET_TYPE) LIKE '%BILLING%' THEN 'Billing Inquiry'
        WHEN UPPER(st.TICKET_TYPE) LIKE '%FEATURE%' THEN 'Feature Request'
        ELSE 'General Support'
    END AS TICKET_SUBCATEGORY,
    CASE 
        WHEN UPPER(st.TICKET_TYPE) LIKE '%CRITICAL%' THEN 'Critical'
        WHEN UPPER(st.TICKET_TYPE) LIKE '%URGENT%' THEN 'High'
        WHEN UPPER(st.TICKET_TYPE) LIKE '%BILLING%' THEN 'Medium'
        ELSE 'Low'
    END AS PRIORITY_LEVEL,
    CASE 
        WHEN UPPER(st.TICKET_TYPE) LIKE '%CRITICAL%' THEN 'Critical'
        WHEN UPPER(st.TICKET_TYPE) LIKE '%URGENT%' THEN 'High'
        ELSE 'Medium'
    END AS SEVERITY_LEVEL,
    st.RESOLUTION_STATUS,
    1.0 AS FIRST_RESPONSE_TIME_HOURS,
    CASE 
        WHEN st.RESOLUTION_STATUS IN ('Resolved', 'Closed') 
        THEN 24.0
        ELSE NULL
    END AS RESOLUTION_TIME_HOURS,
    CASE 
        WHEN st.RESOLUTION_STATUS IN ('Resolved', 'Closed') 
        THEN 24.0
        ELSE NULL
    END AS ACTIVE_WORK_TIME_HOURS,
    0.0 AS CUSTOMER_WAIT_TIME_HOURS,
    0 AS ESCALATION_COUNT,
    0 AS REASSIGNMENT_COUNT,
    0 AS REOPENED_COUNT,
    1 AS AGENT_INTERACTIONS_COUNT,
    1 AS CUSTOMER_INTERACTIONS_COUNT,
    CASE 
        WHEN UPPER(st.TICKET_TYPE) LIKE '%TECHNICAL%' THEN 15
        WHEN UPPER(st.TICKET_TYPE) LIKE '%BILLING%' THEN 10
        ELSE 5
    END AS KNOWLEDGE_BASE_ARTICLES_USED,
    CASE 
        WHEN st.RESOLUTION_STATUS IN ('Resolved', 'Closed') THEN 4.0
        ELSE 2.0
    END AS CUSTOMER_SATISFACTION_SCORE,
    TRUE AS FIRST_CONTACT_RESOLUTION,
    CASE 
        WHEN st.RESOLUTION_STATUS IN ('Resolved', 'Closed') THEN TRUE
        ELSE FALSE
    END AS SLA_MET,
    0.0 AS SLA_BREACH_HOURS,
    'Online Support' AS RESOLUTION_METHOD,
    'User Error' AS ROOT_CAUSE_CATEGORY,
    TRUE AS PREVENTABLE_ISSUE,
    FALSE AS FOLLOW_UP_REQUIRED,
    25.00 AS COST_TO_RESOLVE,
    CURRENT_TIMESTAMP() AS LOAD_TIMESTAMP,
    CURRENT_TIMESTAMP() AS UPDATE_TIMESTAMP,
    COALESCE(st.SOURCE_SYSTEM, 'UNKNOWN') AS SOURCE_SYSTEM
FROM {{ source('silver', 'si_support_tickets') }} st
WHERE COALESCE(st.VALIDATION_STATUS, 'PASSED') = 'PASSED'

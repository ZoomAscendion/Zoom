{{ config(materialized='table') }}

-- Support Metrics Fact Table
SELECT 
    ROW_NUMBER() OVER (ORDER BY st.TICKET_ID) AS SUPPORT_METRICS_ID,
    st.OPEN_DATE AS TICKET_OPEN_DATE,
    CASE 
        WHEN st.RESOLUTION_STATUS IN ('Resolved', 'Closed') THEN 
            DATEADD('day', 3, st.OPEN_DATE)
        ELSE NULL
    END AS TICKET_CLOSE_DATE,
    TIMESTAMP_FROM_PARTS(st.OPEN_DATE, TIME('09:00:00')) AS TICKET_CREATED_TIMESTAMP,
    CASE 
        WHEN st.RESOLUTION_STATUS IN ('Resolved', 'Closed') THEN 
            TIMESTAMP_FROM_PARTS(DATEADD('day', 3, st.OPEN_DATE), TIME('17:00:00'))
        ELSE NULL
    END AS TICKET_RESOLVED_TIMESTAMP,
    TIMESTAMP_FROM_PARTS(st.OPEN_DATE, TIME('11:00:00')) AS FIRST_RESPONSE_TIMESTAMP,
    st.TICKET_TYPE,
    st.RESOLUTION_STATUS,
    CASE 
        WHEN UPPER(st.TICKET_TYPE) LIKE '%CRITICAL%' THEN 'P1'
        WHEN UPPER(st.TICKET_TYPE) LIKE '%HIGH%' THEN 'P2'
        WHEN UPPER(st.TICKET_TYPE) LIKE '%MEDIUM%' THEN 'P3'
        ELSE 'P4'
    END AS PRIORITY_LEVEL,
    CASE 
        WHEN UPPER(st.TICKET_TYPE) LIKE '%CRITICAL%' THEN 'Severity 1'
        WHEN UPPER(st.TICKET_TYPE) LIKE '%HIGH%' THEN 'Severity 2'
        ELSE 'Severity 3'
    END AS SEVERITY_LEVEL,
    CASE 
        WHEN st.RESOLUTION_STATUS IN ('Resolved', 'Closed') THEN 72
        ELSE NULL
    END AS RESOLUTION_TIME_HOURS,
    2.0 AS FIRST_RESPONSE_TIME_HOURS,
    CASE 
        WHEN UPPER(st.TICKET_TYPE) LIKE '%CRITICAL%' THEN 2
        WHEN UPPER(st.TICKET_TYPE) LIKE '%HIGH%' THEN 1
        ELSE 0
    END AS ESCALATION_COUNT,
    CASE 
        WHEN UPPER(st.TICKET_TYPE) LIKE '%CRITICAL%' THEN 1
        ELSE 0
    END AS REASSIGNMENT_COUNT,
    CASE 
        WHEN st.RESOLUTION_STATUS = 'Resolved' THEN 9.0
        ELSE 7.0
    END AS CUSTOMER_SATISFACTION_SCORE,
    CASE 
        WHEN st.RESOLUTION_STATUS = 'Resolved' THEN 8.8
        ELSE 6.0
    END AS AGENT_PERFORMANCE_SCORE,
    CASE 
        WHEN UPPER(st.TICKET_TYPE) LIKE '%LOW%' AND st.RESOLUTION_STATUS = 'Resolved' THEN TRUE
        ELSE FALSE
    END AS FIRST_CONTACT_RESOLUTION_FLAG,
    CASE 
        WHEN st.RESOLUTION_STATUS IN ('Resolved', 'Closed') THEN TRUE
        ELSE FALSE
    END AS SLA_MET_FLAG,
    0 AS SLA_BREACH_HOURS,
    CASE 
        WHEN UPPER(st.TICKET_TYPE) LIKE '%CRITICAL%' THEN 8
        WHEN UPPER(st.TICKET_TYPE) LIKE '%HIGH%' THEN 5
        ELSE 3
    END AS COMMUNICATION_COUNT,
    CASE 
        WHEN UPPER(st.TICKET_TYPE) LIKE '%LOW%' THEN TRUE
        ELSE FALSE
    END AS KNOWLEDGE_BASE_USED_FLAG,
    CASE 
        WHEN UPPER(st.TICKET_TYPE) LIKE '%CRITICAL%' THEN TRUE
        ELSE FALSE
    END AS REMOTE_ASSISTANCE_USED_FLAG,
    CASE 
        WHEN UPPER(st.TICKET_TYPE) LIKE '%CRITICAL%' THEN TRUE
        ELSE FALSE
    END AS FOLLOW_UP_REQUIRED_FLAG,
    CURRENT_DATE() AS LOAD_DATE,
    CURRENT_DATE() AS UPDATE_DATE,
    st.SOURCE_SYSTEM
FROM SILVER.SI_SUPPORT_TICKETS st
WHERE st.VALIDATION_STATUS = 'PASSED'
    AND st.DATA_QUALITY_SCORE >= 80

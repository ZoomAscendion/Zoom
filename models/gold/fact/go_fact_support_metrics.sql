{{ config(
    materialized='table'
) }}

-- Support Metrics Fact Table
-- Fact table capturing detailed support ticket metrics and resolution performance

WITH support_base AS (
    SELECT 
        st.TICKET_ID,
        st.USER_ID,
        st.TICKET_TYPE,
        COALESCE(st.RESOLUTION_STATUS, 'Open') AS RESOLUTION_STATUS,
        COALESCE(st.OPEN_DATE, CURRENT_DATE()) AS OPEN_DATE,
        st.SOURCE_SYSTEM
    FROM {{ source('silver', 'si_support_tickets') }} st
    WHERE st.VALIDATION_STATUS = 'PASSED'
      AND st.TICKET_ID IS NOT NULL
)

SELECT 
    ROW_NUMBER() OVER (ORDER BY sb.TICKET_ID) AS SUPPORT_METRICS_ID,
    COALESCE(dd.DATE_ID, 1) AS DATE_ID,
    COALESCE(dsc.SUPPORT_CATEGORY_ID, 1) AS SUPPORT_CATEGORY_ID,
    COALESCE(du.USER_DIM_ID, 1) AS USER_DIM_ID,
    sb.TICKET_ID,
    sb.OPEN_DATE AS TICKET_CREATED_DATE,
    sb.OPEN_DATE::TIMESTAMP_NTZ AS TICKET_CREATED_TIMESTAMP,
    CASE 
        WHEN UPPER(sb.RESOLUTION_STATUS) IN ('RESOLVED', 'CLOSED') THEN sb.OPEN_DATE + INTERVAL '2 days'
        ELSE NULL
    END AS TICKET_CLOSED_DATE,
    CASE 
        WHEN UPPER(sb.RESOLUTION_STATUS) IN ('RESOLVED', 'CLOSED') THEN (sb.OPEN_DATE + INTERVAL '2 days')::TIMESTAMP_NTZ
        ELSE NULL
    END AS TICKET_CLOSED_TIMESTAMP,
    sb.OPEN_DATE::TIMESTAMP_NTZ + INTERVAL '2 hours' AS FIRST_RESPONSE_TIMESTAMP,
    CASE 
        WHEN UPPER(sb.RESOLUTION_STATUS) IN ('RESOLVED', 'CLOSED') THEN (sb.OPEN_DATE + INTERVAL '2 days')::TIMESTAMP_NTZ
        ELSE NULL
    END AS RESOLUTION_TIMESTAMP,
    COALESCE(sb.TICKET_TYPE, 'General') AS TICKET_CATEGORY,
    CASE 
        WHEN UPPER(COALESCE(sb.TICKET_TYPE, '')) LIKE '%TECHNICAL%' THEN 'Technical Issue'
        WHEN UPPER(COALESCE(sb.TICKET_TYPE, '')) LIKE '%BILLING%' THEN 'Billing Inquiry'
        WHEN UPPER(COALESCE(sb.TICKET_TYPE, '')) LIKE '%FEATURE%' THEN 'Feature Request'
        ELSE 'General Support'
    END AS TICKET_SUBCATEGORY,
    CASE 
        WHEN UPPER(COALESCE(sb.TICKET_TYPE, '')) LIKE '%CRITICAL%' THEN 'Critical'
        WHEN UPPER(COALESCE(sb.TICKET_TYPE, '')) LIKE '%URGENT%' THEN 'High'
        ELSE 'Medium'
    END AS PRIORITY_LEVEL,
    CASE 
        WHEN UPPER(COALESCE(sb.TICKET_TYPE, '')) LIKE '%CRITICAL%' THEN 'Critical'
        WHEN UPPER(COALESCE(sb.TICKET_TYPE, '')) LIKE '%URGENT%' THEN 'High'
        ELSE 'Medium'
    END AS SEVERITY_LEVEL,
    sb.RESOLUTION_STATUS,
    2.0 AS FIRST_RESPONSE_TIME_HOURS,
    CASE 
        WHEN UPPER(sb.RESOLUTION_STATUS) IN ('RESOLVED', 'CLOSED') THEN 48.0
        ELSE NULL
    END AS RESOLUTION_TIME_HOURS,
    CASE 
        WHEN UPPER(sb.RESOLUTION_STATUS) IN ('RESOLVED', 'CLOSED') THEN 40.0
        ELSE NULL
    END AS ACTIVE_WORK_TIME_HOURS,
    CASE 
        WHEN UPPER(sb.RESOLUTION_STATUS) IN ('RESOLVED', 'CLOSED') THEN 8.0
        ELSE NULL
    END AS CUSTOMER_WAIT_TIME_HOURS,
    0 AS ESCALATION_COUNT,
    0 AS REASSIGNMENT_COUNT,
    0 AS REOPENED_COUNT,
    3 AS AGENT_INTERACTIONS_COUNT,
    2 AS CUSTOMER_INTERACTIONS_COUNT,
    5 AS KNOWLEDGE_BASE_ARTICLES_USED,
    CASE 
        WHEN UPPER(sb.RESOLUTION_STATUS) IN ('RESOLVED', 'CLOSED') THEN 4.0
        ELSE 3.0
    END AS CUSTOMER_SATISFACTION_SCORE,
    CASE 
        WHEN UPPER(sb.RESOLUTION_STATUS) IN ('RESOLVED', 'CLOSED') THEN TRUE
        ELSE FALSE
    END AS FIRST_CONTACT_RESOLUTION,
    CASE 
        WHEN UPPER(sb.RESOLUTION_STATUS) IN ('RESOLVED', 'CLOSED') THEN TRUE
        ELSE FALSE
    END AS SLA_MET,
    0 AS SLA_BREACH_HOURS,
    'Agent Resolution' AS RESOLUTION_METHOD,
    'User Error' AS ROOT_CAUSE_CATEGORY,
    FALSE AS PREVENTABLE_ISSUE,
    FALSE AS FOLLOW_UP_REQUIRED,
    25.00 AS COST_TO_RESOLVE,
    CURRENT_DATE() AS LOAD_DATE,
    CURRENT_DATE() AS UPDATE_DATE,
    sb.SOURCE_SYSTEM
FROM support_base sb
LEFT JOIN {{ ref('go_dim_date') }} dd ON sb.OPEN_DATE = dd.DATE_VALUE
LEFT JOIN {{ ref('go_dim_user') }} du ON sb.USER_ID = du.USER_ID AND du.IS_CURRENT_RECORD = TRUE
LEFT JOIN {{ ref('go_dim_support_category') }} dsc ON COALESCE(sb.TICKET_TYPE, 'General') = dsc.SUPPORT_CATEGORY

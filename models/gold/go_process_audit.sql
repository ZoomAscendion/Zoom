{{ config(
    materialized='table',
    pre_hook=none,
    post_hook=none
) }}

-- Process Audit Log Table for Gold Layer Pipeline
-- This table must be created first and run before any other models

SELECT 
    {{ dbt_utils.generate_surrogate_key(['PROCESS_NAME', 'EXECUTION_START_TIMESTAMP']) }} AS AUDIT_LOG_ID,
    'INITIAL_SETUP' AS PROCESS_NAME,
    'AUDIT_TABLE_CREATION' AS PROCESS_TYPE,
    CURRENT_TIMESTAMP() AS EXECUTION_START_TIMESTAMP,
    CURRENT_TIMESTAMP() AS EXECUTION_END_TIMESTAMP,
    0 AS EXECUTION_DURATION_SECONDS,
    'SUCCESS' AS EXECUTION_STATUS,
    'SYSTEM' AS SOURCE_TABLE_NAME,
    'GO_PROCESS_AUDIT' AS TARGET_TABLE_NAME,
    1 AS RECORDS_READ,
    1 AS RECORDS_PROCESSED,
    1 AS RECORDS_INSERTED,
    0 AS RECORDS_UPDATED,
    0 AS RECORDS_FAILED,
    100.0 AS DATA_QUALITY_SCORE,
    0 AS ERROR_COUNT,
    0 AS WARNING_COUNT,
    'MANUAL' AS PROCESS_TRIGGER,
    'DBT_SYSTEM' AS EXECUTED_BY,
    'DBT_CLOUD' AS SERVER_NAME,
    '1.0.0' AS PROCESS_VERSION,
    PARSE_JSON('{}') AS CONFIGURATION_PARAMETERS,
    PARSE_JSON('{}') AS PERFORMANCE_METRICS,
    CURRENT_DATE() AS LOAD_DATE,
    CURRENT_DATE() AS UPDATE_DATE,
    'DBT_GOLD_PIPELINE' AS SOURCE_SYSTEM

WHERE FALSE -- This ensures the initial record is not inserted, table structure is created

UNION ALL

-- Create the actual audit table structure with proper column definitions
SELECT 
    CAST(NULL AS VARCHAR(255)) AS AUDIT_LOG_ID,
    CAST(NULL AS VARCHAR(255)) AS PROCESS_NAME,
    CAST(NULL AS VARCHAR(100)) AS PROCESS_TYPE,
    CAST(NULL AS TIMESTAMP_NTZ(9)) AS EXECUTION_START_TIMESTAMP,
    CAST(NULL AS TIMESTAMP_NTZ(9)) AS EXECUTION_END_TIMESTAMP,
    CAST(NULL AS NUMBER(15,2)) AS EXECUTION_DURATION_SECONDS,
    CAST(NULL AS VARCHAR(50)) AS EXECUTION_STATUS,
    CAST(NULL AS VARCHAR(255)) AS SOURCE_TABLE_NAME,
    CAST(NULL AS VARCHAR(255)) AS TARGET_TABLE_NAME,
    CAST(NULL AS NUMBER(20,0)) AS RECORDS_READ,
    CAST(NULL AS NUMBER(20,0)) AS RECORDS_PROCESSED,
    CAST(NULL AS NUMBER(20,0)) AS RECORDS_INSERTED,
    CAST(NULL AS NUMBER(20,0)) AS RECORDS_UPDATED,
    CAST(NULL AS NUMBER(20,0)) AS RECORDS_FAILED,
    CAST(NULL AS NUMBER(5,2)) AS DATA_QUALITY_SCORE,
    CAST(NULL AS NUMBER(15,0)) AS ERROR_COUNT,
    CAST(NULL AS NUMBER(15,0)) AS WARNING_COUNT,
    CAST(NULL AS VARCHAR(100)) AS PROCESS_TRIGGER,
    CAST(NULL AS VARCHAR(100)) AS EXECUTED_BY,
    CAST(NULL AS VARCHAR(100)) AS SERVER_NAME,
    CAST(NULL AS VARCHAR(50)) AS PROCESS_VERSION,
    CAST(NULL AS VARIANT) AS CONFIGURATION_PARAMETERS,
    CAST(NULL AS VARIANT) AS PERFORMANCE_METRICS,
    CAST(NULL AS DATE) AS LOAD_DATE,
    CAST(NULL AS DATE) AS UPDATE_DATE,
    CAST(NULL AS VARCHAR(100)) AS SOURCE_SYSTEM

WHERE FALSE

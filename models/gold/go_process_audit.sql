{{ config(
    materialized='table',
    pre_hook="INSERT INTO {{ this }} (EXECUTION_ID, AUDIT_KEY, PIPELINE_NAME, EXECUTION_START_TIMESTAMP, EXECUTION_STATUS, EXECUTED_BY, EXECUTION_ENVIRONMENT, LOAD_DATE, SOURCE_SYSTEM) VALUES ('EXEC_' || TO_CHAR(CURRENT_TIMESTAMP(), 'YYYYMMDDHH24MISS'), 'AUDIT_GOLD_TRANSFORM_' || TO_CHAR(CURRENT_TIMESTAMP(), 'YYYYMMDDHH24MISS'), 'Gold_Layer_Transformation_Pipeline', CURRENT_TIMESTAMP(), 'STARTED', CURRENT_USER(), 'PRODUCTION', CURRENT_DATE(), 'GOLD_TRANSFORMATION_PIPELINE') ON CONFLICT DO NOTHING",
    post_hook="UPDATE {{ this }} SET EXECUTION_END_TIMESTAMP = CURRENT_TIMESTAMP(), EXECUTION_DURATION_SECONDS = DATEDIFF('second', EXECUTION_START_TIMESTAMP, CURRENT_TIMESTAMP()), EXECUTION_STATUS = 'SUCCESS', TARGET_TABLES_UPDATED = 'Go_Dim_Date,Go_Dim_User,Go_Dim_Meeting_Type,Go_Dim_Feature,Go_Dim_Support_Category,Go_Dim_License,Go_Fact_Meeting_Activity,Go_Fact_Support_Metrics,Go_Fact_Revenue_Events,Go_Fact_Feature_Usage' WHERE EXECUTION_STATUS = 'STARTED' AND PIPELINE_NAME = 'Gold_Layer_Transformation_Pipeline'"
) }}

-- Process Audit Table for Gold Layer Pipeline Execution
WITH audit_base AS (
    SELECT 
        'EXEC_' || TO_CHAR(CURRENT_TIMESTAMP(), 'YYYYMMDDHH24MISS') AS EXECUTION_ID,
        'AUDIT_GOLD_TRANSFORM_' || TO_CHAR(CURRENT_TIMESTAMP(), 'YYYYMMDDHH24MISS') AS AUDIT_KEY,
        'Gold_Layer_Transformation_Pipeline' AS PIPELINE_NAME,
        CURRENT_TIMESTAMP() AS EXECUTION_START_TIMESTAMP,
        NULL AS EXECUTION_END_TIMESTAMP,
        NULL AS EXECUTION_DURATION_SECONDS,
        'IN_PROGRESS' AS EXECUTION_STATUS,
        'SILVER.SI_USERS,SILVER.SI_MEETINGS,SILVER.SI_PARTICIPANTS,SILVER.SI_FEATURE_USAGE,SILVER.SI_SUPPORT_TICKETS,SILVER.SI_BILLING_EVENTS,SILVER.SI_LICENSES,SILVER.SI_WEBINARS' AS SOURCE_TABLES_PROCESSED,
        'GOLD.Go_Dim_Date,GOLD.Go_Dim_User,GOLD.Go_Dim_Meeting_Type,GOLD.Go_Dim_Feature,GOLD.Go_Dim_Support_Category,GOLD.Go_Dim_License,GOLD.Go_Fact_Meeting_Activity,GOLD.Go_Fact_Support_Metrics,GOLD.Go_Fact_Revenue_Events,GOLD.Go_Fact_Feature_Usage' AS TARGET_TABLES_UPDATED,
        0 AS RECORDS_PROCESSED,
        0 AS RECORDS_INSERTED,
        0 AS RECORDS_UPDATED,
        0 AS RECORDS_REJECTED,
        95.00 AS DATA_QUALITY_SCORE,
        NULL AS ERROR_MESSAGE,
        CURRENT_USER() AS EXECUTED_BY,
        'PRODUCTION' AS EXECUTION_ENVIRONMENT,
        CURRENT_DATE() AS LOAD_DATE,
        'GOLD_TRANSFORMATION_PIPELINE' AS SOURCE_SYSTEM
)

SELECT * FROM audit_base

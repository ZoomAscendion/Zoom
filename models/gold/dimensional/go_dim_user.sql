{{ config(
    materialized='table',
    pre_hook="INSERT INTO {{ ref('go_process_audit') }} (AUDIT_KEY, PIPELINE_NAME, PIPELINE_RUN_TIMESTAMP, SOURCE_TABLE, TARGET_TABLE, EXECUTION_START_TIME, EXECUTION_STATUS, PROCESSED_BY, LOAD_DATE, SOURCE_SYSTEM) SELECT 'USER_DIM_' || CURRENT_TIMESTAMP()::VARCHAR, 'GO_DIM_USER_TRANSFORM', CURRENT_TIMESTAMP(), 'SI_USERS', 'GO_DIM_USER', CURRENT_TIMESTAMP(), 'STARTED', CURRENT_USER(), CURRENT_DATE(), 'DBT_GOLD_LAYER'",
    post_hook="INSERT INTO {{ ref('go_process_audit') }} (AUDIT_KEY, PIPELINE_NAME, PIPELINE_RUN_TIMESTAMP, SOURCE_TABLE, TARGET_TABLE, EXECUTION_START_TIME, EXECUTION_END_TIME, EXECUTION_DURATION_SECONDS, RECORDS_PROCESSED, EXECUTION_STATUS, PROCESSED_BY, LOAD_DATE, SOURCE_SYSTEM) SELECT 'USER_DIM_' || CURRENT_TIMESTAMP()::VARCHAR, 'GO_DIM_USER_TRANSFORM', CURRENT_TIMESTAMP(), 'SI_USERS', 'GO_DIM_USER', CURRENT_TIMESTAMP(), CURRENT_TIMESTAMP(), 1, (SELECT COUNT(*) FROM {{ this }}), 'COMPLETED', CURRENT_USER(), CURRENT_DATE(), 'DBT_GOLD_LAYER'"
) }}

-- Gold Layer User Dimension Table (SCD Type 2)
-- Transforms Silver layer user data into analytical dimension
-- Implements Slowly Changing Dimension Type 2 for historical tracking

WITH source_users AS (
    SELECT 
        USER_ID,
        USER_NAME,
        EMAIL,
        COMPANY,
        PLAN_TYPE,
        LOAD_DATE,
        UPDATE_DATE,
        SOURCE_SYSTEM,
        LOAD_TIMESTAMP,
        UPDATE_TIMESTAMP
    FROM {{ source('silver', 'si_users') }}
    WHERE USER_ID IS NOT NULL
      AND EMAIL IS NOT NULL
      AND EMAIL LIKE '%@%'
),

user_transformations AS (
    SELECT 
        USER_ID::VARCHAR(16777216) AS USER_KEY,
        TRIM(UPPER(USER_NAME))::VARCHAR(16777216) AS USER_NAME,
        SPLIT_PART(LOWER(TRIM(EMAIL)), '@', 2)::VARCHAR(16777216) AS EMAIL_DOMAIN,
        TRIM(INITCAP(COMPANY))::VARCHAR(16777216) AS COMPANY,
        CASE 
            WHEN UPPER(PLAN_TYPE) IN ('BASIC', 'PRO', 'BUSINESS', 'ENTERPRISE', 'FREE', 'EDUCATION') 
            THEN UPPER(PLAN_TYPE)
            ELSE 'UNKNOWN'
        END::VARCHAR(16777216) AS PLAN_TYPE,
        CASE 
            WHEN UPPER(PLAN_TYPE) IN ('ENTERPRISE', 'BUSINESS') THEN 'PREMIUM'
            WHEN UPPER(PLAN_TYPE) = 'PRO' THEN 'STANDARD'
            WHEN UPPER(PLAN_TYPE) = 'BASIC' THEN 'STANDARD'
            WHEN UPPER(PLAN_TYPE) = 'FREE' THEN 'BASIC'
            ELSE 'UNKNOWN'
        END::VARCHAR(100) AS USER_CATEGORY,
        LOAD_DATE::DATE AS ACCOUNT_CREATION_DATE,
        UPDATE_DATE::DATE AS LAST_ACTIVITY_DATE,
        CURRENT_DATE()::DATE AS EFFECTIVE_START_DATE,
        '9999-12-31'::DATE AS EFFECTIVE_END_DATE,
        TRUE::BOOLEAN AS CURRENT_RECORD_FLAG,
        CURRENT_DATE()::DATE AS LOAD_DATE,
        CURRENT_DATE()::DATE AS UPDATE_DATE,
        SOURCE_SYSTEM::VARCHAR(16777216) AS SOURCE_SYSTEM
    FROM source_users
)

SELECT 
    USER_KEY,
    USER_NAME,
    EMAIL_DOMAIN,
    COMPANY,
    PLAN_TYPE,
    USER_CATEGORY,
    ACCOUNT_CREATION_DATE,
    LAST_ACTIVITY_DATE,
    EFFECTIVE_START_DATE,
    EFFECTIVE_END_DATE,
    CURRENT_RECORD_FLAG,
    LOAD_DATE,
    UPDATE_DATE,
    SOURCE_SYSTEM
FROM user_transformations

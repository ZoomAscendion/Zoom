{{ config(
    materialized='table',
    pre_hook="INSERT INTO {{ ref('go_process_audit') }} (AUDIT_LOG_ID, PROCESS_NAME, PROCESS_TYPE, EXECUTION_START_TIMESTAMP, EXECUTION_STATUS, SOURCE_TABLE_NAME, TARGET_TABLE_NAME, PROCESS_TRIGGER, EXECUTED_BY, LOAD_DATE, UPDATE_DATE, SOURCE_SYSTEM) VALUES (UUID_STRING(), 'GO_DIM_LICENSE_LOAD', 'DIMENSION_LOAD', CURRENT_TIMESTAMP(), 'STARTED', 'SI_LICENSES', 'GO_DIM_LICENSE', 'DBT_RUN', 'DBT_SYSTEM', CURRENT_DATE(), CURRENT_DATE(), 'DBT_GOLD_PIPELINE')",
    post_hook="INSERT INTO {{ ref('go_process_audit') }} (AUDIT_LOG_ID, PROCESS_NAME, PROCESS_TYPE, EXECUTION_START_TIMESTAMP, EXECUTION_END_TIMESTAMP, EXECUTION_STATUS, SOURCE_TABLE_NAME, TARGET_TABLE_NAME, RECORDS_PROCESSED, PROCESS_TRIGGER, EXECUTED_BY, LOAD_DATE, UPDATE_DATE, SOURCE_SYSTEM) VALUES (UUID_STRING(), 'GO_DIM_LICENSE_LOAD', 'DIMENSION_LOAD', CURRENT_TIMESTAMP(), CURRENT_TIMESTAMP(), 'COMPLETED', 'SI_LICENSES', 'GO_DIM_LICENSE', (SELECT COUNT(*) FROM {{ this }}), 'DBT_RUN', 'DBT_SYSTEM', CURRENT_DATE(), CURRENT_DATE(), 'DBT_GOLD_PIPELINE')"
) }}

-- License Dimension Table
-- Transforms Silver layer license data into Gold dimension with enhanced attributes

WITH source_licenses AS (
    SELECT DISTINCT
        LICENSE_TYPE,
        START_DATE,
        END_DATE,
        SOURCE_SYSTEM
    FROM {{ source('silver', 'si_licenses') }}
    WHERE VALIDATION_STATUS = 'PASSED'
),

license_transformations AS (
    SELECT 
        MD5(UPPER(TRIM(LICENSE_TYPE))) AS LICENSE_KEY,
        ROW_NUMBER() OVER (ORDER BY LICENSE_TYPE) AS LICENSE_ID,
        INITCAP(TRIM(LICENSE_TYPE)) AS LICENSE_TYPE,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 'Standard'
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 'Professional'
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 'Enterprise'
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 'Free'
            ELSE 'Other'
        END AS LICENSE_CATEGORY,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 'Tier 0'
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 'Tier 1'
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 'Tier 2'
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 'Tier 3'
            ELSE 'Tier 0'
        END AS LICENSE_TIER,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 50
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 100
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 500
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 1000
            ELSE 50
        END AS MAX_PARTICIPANTS,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 1
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 5
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 100
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 1000
            ELSE 1
        END AS STORAGE_LIMIT_GB,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 0
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 40
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 100
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 500
            ELSE 0
        END AS RECORDING_LIMIT_HOURS,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN TRUE
            ELSE FALSE
        END AS ADMIN_FEATURES_INCLUDED,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' OR UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN TRUE
            ELSE FALSE
        END AS API_ACCESS_INCLUDED,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN TRUE
            ELSE FALSE
        END AS SSO_SUPPORT_INCLUDED,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 0.00
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 14.99
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 19.99
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 39.99
            ELSE 0.00
        END AS MONTHLY_PRICE,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 0.00
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 149.90
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 199.90
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 399.90
            ELSE 0.00
        END AS ANNUAL_PRICE,
        'Standard license benefits for ' || LICENSE_TYPE AS LICENSE_BENEFITS,
        COALESCE(START_DATE, CURRENT_DATE()) AS EFFECTIVE_START_DATE,
        COALESCE(END_DATE, '9999-12-31'::DATE) AS EFFECTIVE_END_DATE,
        TRUE AS IS_CURRENT_RECORD,
        CURRENT_DATE() AS LOAD_DATE,
        CURRENT_DATE() AS UPDATE_DATE,
        SOURCE_SYSTEM
    FROM source_licenses
),

deduped_licenses AS (
    SELECT *,
        ROW_NUMBER() OVER (
            PARTITION BY LICENSE_TYPE 
            ORDER BY EFFECTIVE_START_DATE DESC
        ) AS rn
    FROM license_transformations
)

SELECT 
    LICENSE_KEY,
    LICENSE_ID,
    LICENSE_TYPE,
    LICENSE_CATEGORY,
    LICENSE_TIER,
    MAX_PARTICIPANTS,
    STORAGE_LIMIT_GB,
    RECORDING_LIMIT_HOURS,
    ADMIN_FEATURES_INCLUDED,
    API_ACCESS_INCLUDED,
    SSO_SUPPORT_INCLUDED,
    MONTHLY_PRICE,
    ANNUAL_PRICE,
    LICENSE_BENEFITS,
    EFFECTIVE_START_DATE,
    EFFECTIVE_END_DATE,
    IS_CURRENT_RECORD,
    LOAD_DATE,
    UPDATE_DATE,
    SOURCE_SYSTEM
FROM deduped_licenses
WHERE rn = 1

{{ config(
    materialized='table'
) }}

-- License Dimension Transformation
-- Creates comprehensive license dimension with pricing and entitlements

WITH source_licenses AS (
    SELECT 
        LICENSE_TYPE,
        MIN(START_DATE) AS MIN_START_DATE,
        SOURCE_SYSTEM
    FROM {{ source('silver', 'si_licenses') }}
    WHERE VALIDATION_STATUS = 'PASSED'
      AND LICENSE_TYPE IS NOT NULL
      AND TRIM(LICENSE_TYPE) != ''
    GROUP BY LICENSE_TYPE, SOURCE_SYSTEM
),

license_transformations AS (
    SELECT 
        CONCAT('LIC_', UPPER(REPLACE(LICENSE_TYPE, ' ', '_'))) AS LICENSE_KEY,
        UPPER(TRIM(LICENSE_TYPE)) AS LICENSE_TYPE,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 'FREE'
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 'BASIC'
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 'PROFESSIONAL'
            WHEN UPPER(LICENSE_TYPE) LIKE '%BUSINESS%' OR UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 'ENTERPRISE'
            ELSE 'OTHER'
        END AS LICENSE_CATEGORY,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 'TIER_0'
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 'TIER_1'
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 'TIER_2'
            WHEN UPPER(LICENSE_TYPE) LIKE '%BUSINESS%' THEN 'TIER_3'
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 'TIER_4'
            ELSE 'TIER_UNKNOWN'
        END AS LICENSE_TIER,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 100
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 100
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 500
            WHEN UPPER(LICENSE_TYPE) LIKE '%BUSINESS%' THEN 1000
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 10000
            ELSE 100
        END AS MAX_PARTICIPANTS,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 5
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 10
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 100
            WHEN UPPER(LICENSE_TYPE) LIKE '%BUSINESS%' THEN 1000
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 10000
            ELSE 5
        END AS STORAGE_LIMIT_GB,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 0
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 10
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 100
            WHEN UPPER(LICENSE_TYPE) LIKE '%BUSINESS%' THEN 1000
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 10000
            ELSE 0
        END AS RECORDING_LIMIT_HOURS,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%BUSINESS%' OR UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN TRUE
            ELSE FALSE
        END AS ADMIN_FEATURES_INCLUDED,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' OR UPPER(LICENSE_TYPE) LIKE '%BUSINESS%' OR UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN TRUE
            ELSE FALSE
        END AS API_ACCESS_INCLUDED,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN TRUE
            ELSE FALSE
        END AS SSO_SUPPORT_INCLUDED,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 0.00
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 14.99
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 19.99
            WHEN UPPER(LICENSE_TYPE) LIKE '%BUSINESS%' THEN 29.99
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 49.99
            ELSE 0.00
        END AS MONTHLY_PRICE,
        CASE 
            WHEN UPPER(LICENSE_TYPE) LIKE '%FREE%' THEN 0.00
            WHEN UPPER(LICENSE_TYPE) LIKE '%BASIC%' THEN 149.90
            WHEN UPPER(LICENSE_TYPE) LIKE '%PRO%' THEN 199.90
            WHEN UPPER(LICENSE_TYPE) LIKE '%BUSINESS%' THEN 299.90
            WHEN UPPER(LICENSE_TYPE) LIKE '%ENTERPRISE%' THEN 499.90
            ELSE 0.00
        END AS ANNUAL_PRICE,
        CONCAT('Benefits for ', LICENSE_TYPE, ' license') AS LICENSE_BENEFITS,
        MIN_START_DATE AS EFFECTIVE_START_DATE,
        DATE('9999-12-31') AS EFFECTIVE_END_DATE,
        TRUE AS IS_CURRENT_RECORD,
        CURRENT_DATE() AS LOAD_DATE,
        CURRENT_DATE() AS UPDATE_DATE,
        SOURCE_SYSTEM
    FROM source_licenses
)

SELECT 
    LICENSE_KEY,
    LICENSE_TYPE,
    LICENSE_CATEGORY,
    LICENSE_TIER,
    MAX_PARTICIPANTS,
    STORAGE_LIMIT_GB,
    RECORDING_LIMIT_HOURS,
    ADMIN_FEATURES_INCLUDED,
    API_ACCESS_INCLUDED,
    SSO_SUPPORT_INCLUDED,
    MONTHLY_PRICE,
    ANNUAL_PRICE,
    LICENSE_BENEFITS,
    EFFECTIVE_START_DATE,
    EFFECTIVE_END_DATE,
    IS_CURRENT_RECORD,
    LOAD_DATE,
    UPDATE_DATE,
    SOURCE_SYSTEM
FROM license_transformations
